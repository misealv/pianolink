<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso Profesores | Piano Link</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --card-bg: #262626;
      --text-color: #dcdcdc;
      --accent: #ff764d; 
      --border: #454545;
    }

    /* --- ESTILOS GENERALES --- */
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    /* --- TARJETA DE LOGIN --- */
    .login-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 40px;
      border-radius: 8px;
      width: 100%;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      position: relative;
      z-index: 1;
    }

    /* ESTILO PARA EL LOGO CARGADO (DIN√ÅMICO) */
    #globalLogo {
        max-width: 350px;
        height: auto;
        margin-bottom: 20px;
        filter: drop-shadow(0 0 10px rgba(255,255,255,0.1));
        display: none; /* Se muestra con JS si existe */
    }

    .brand-logo {
      font-size: 24px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 5px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .brand-subtitle {
      font-size: 11px;
      color: var(--accent);
      margin-bottom: 30px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      background: #121212;
      border: 1px solid var(--border);
      color: #fff;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }
    input:focus { border-color: var(--accent); }
    
    button.btn-login {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      border: none;
      letter-spacing: 1px;
      text-transform: uppercase;
      transition: background 0.3s, transform 0.1s;
    }
    button.btn-login:hover { background: #ff9f7e; }
    button.btn-login:active { transform: translateY(1px); }
    
    #msg {
      margin-top: 20px;
      font-size: 12px;
      min-height: 20px;
      font-weight: 500;
    }

    /* --- BOT√ìN DE LINK --- */
    .founders-link {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #333;
    }
    .btn-text {
        background: none; border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 13px;
        text-decoration: none;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    .btn-text:hover { opacity: 1; text-decoration: underline; }

    /* --- MODAL --- */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: #222;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        border: 1px solid #444;
        position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        animation: slideUp 0.3s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .close-btn {
        position: absolute;
        top: 10px; right: 15px;
        background: none; border: none;
        color: #888; font-size: 28px; cursor: pointer;
        transition: color 0.2s;
    }
    .close-btn:hover { color: #fff; }

    .founders-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    @media (max-width: 600px) {
        .founders-grid { grid-template-columns: 1fr; }
    }

    .founder-card {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-top: 3px solid var(--accent); 
        transition: transform 0.2s;
    }
    .founder-card:hover { transform: translateY(-3px); }

    .founder-card h3 { margin: 10px 0 5px 0; color: white; font-size: 16px; }
    .founder-card .flag { font-size: 12px; color: #aaa; display: block; margin-bottom: 10px; }
    .founder-card p { font-size: 13px; color: #ccc; line-height: 1.4; margin: 0; }

    .avatar-circle {
        width: 50px; height: 50px;
        background: var(--accent);
        color: #000;
        border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-weight: 800; font-size: 18px;
        margin: 0 auto 10px auto;
        box-shadow: 0 4px 10px rgba(255, 118, 77, 0.3);
    }
  </style>
</head>
<body>

  <div class="login-card">
    
    <img id="globalLogo" src="">

    <div id="defaultBrand">
        <div class="brand-logo">üéπ Piano Link</div>
        <div class="brand-subtitle">Acceso Docente</div>
    </div>
    
    <form id="loginForm">
      <input type="email" id="email" placeholder="Correo electr√≥nico" required>
      <input type="password" id="password" placeholder="Contrase√±a" required>
      <button type="submit" class="btn-login">INGRESAR</button>
    </form>
    
    <div id="msg"></div>

    <div class="founders-link">
        <span style="color: #666; font-size: 12px;">Respaldo Acad√©mico</span><br>
        <button id="btnFounders" class="btn-text">
            ‚ú® Ver Profesores Fundadores
        </button>
    </div>
  </div>

  <div id="foundersModal" class="modal-overlay">
    <div class="modal-content">
        <button id="btnCloseModal" class="close-btn">&times;</button>
        
        <h2 style="color:var(--accent); margin-bottom:10px; text-align:center; font-size: 20px; text-transform: uppercase; letter-spacing: 1px;">
            Maestros Fundadores
        </h2>
        <p style="text-align:center; color:#888; margin-bottom:25px; font-size: 13px;">
            La visi√≥n pedag√≥gica detr√°s de Piano Link.
        </p>

        <div class="founders-grid" id="foundersGrid">
          <p style="grid-column: 1 / -1; text-align: center;">Cargando...</p>
        </div>
    </div>
  </div>

  <script>
    // --- 0. L√ìGICA DE IDENTIDAD (LOGO DEFINIDO) ---
    (async function loadBrand() {
        try {
            const res = await fetch('/api/auth/platform-public');
            const config = await res.json();
            
            if (config.logoUrl) {
                const img = document.getElementById('globalLogo');
                img.src = config.logoUrl;
                img.style.display = 'inline-block'; // Mostrar imagen
                
                // Ocultar el texto por defecto para que no se duplique
                const def = document.getElementById('defaultBrand');
                if(def) def.style.display = 'none';
            }

            if (config.name) document.title = `Acceso | ${config.name}`;
            
            if (config.faviconUrl) {
                let link = document.createElement('link');
                link.rel = 'icon'; link.href = config.faviconUrl;
                document.head.appendChild(link);
            }
        } catch (e) { console.log("Usando marca por defecto"); }
    })();

    // --- 1. L√ìGICA DE LOGIN (CORREGIDA PARA REDIRECCI√ìN) ---
    const form = document.getElementById('loginForm');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = form.querySelector('button');
      btn.disabled = true;
      btn.textContent = "Verificando...";
      msg.textContent = "";
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          msg.style.color = "#b4e080"; 
          msg.textContent = "‚úÖ Acceso concedido. Redirigiendo...";
          
          // ‚úÖ FIX IMPORTANTE: 
          // Detectamos si el servidor devuelve { user: ... } o el objeto user directo
          // para asegurarnos de guardar y leer los datos correctamente.
          const userToSave = data.user || data;

          localStorage.setItem('pianoUser', JSON.stringify(userToSave));
          
          setTimeout(() => {
            // Usamos userToSave para leer el rol
            if (userToSave.role === 'admin') {
              window.location.href = "admin.html";
            } else if (userToSave.role === 'teacher') {
              window.location.href = "dashboard.html";
            } else {
              window.location.href = "/";
            }
          }, 800);

        } else {
          msg.style.color = "#ff4d4d"; 
          msg.textContent = "‚ùå " + (data.message || "Credenciales incorrectas");
          btn.disabled = false;
          btn.textContent = "INGRESAR";
        }
      } catch (error) {
        console.error(error);
        msg.textContent = "‚ö†Ô∏è Error de conexi√≥n.";
        msg.style.color = "#ff4d4d";
        btn.disabled = false;
        btn.textContent = "INGRESAR";
      }
    });

    // --- 2. L√ìGICA DEL MODAL DE FUNDADORES ---
    const modal = document.getElementById('foundersModal');
    const btnOpen = document.getElementById('btnFounders');
    const btnClose = document.getElementById('btnCloseModal');
    
    async function loadFounders() {
        const gridContainer = document.querySelector('.founders-grid');
        gridContainer.innerHTML = '<p style="color:#888; text-align:center; grid-column:1/-1;">Cargando maestros...</p>';

        try {
            const response = await fetch('/api/teacher/founders');
            let founders = await response.json(); 

            gridContainer.innerHTML = ''; 

            if (!founders || founders.length === 0) {
                gridContainer.innerHTML = '<p style="color:#888; text-align:center; grid-column:1/-1;">Pronto anunciaremos a nuestros fundadores.</p>';
                return;
            }

            // Ordenar: Tu nombre primero
            const nameToPrioritize = "Miguel"; 
            founders.sort((a, b) => {
                if (a.name && a.name.includes(nameToPrioritize)) return -1;
                if (b.name && b.name.includes(nameToPrioritize)) return 1;
                return 0; 
            });

            founders.forEach(founder => {
                const branding = founder.branding || {};
                const colors = branding.colors || {};
                const name = founder.name;
                const bio = branding.bio || 'Profesor Fundador de Piano Link.';
                const country = branding.country || 'üè≥Ô∏è Internacional'; 
                const baseColor = colors.base || '#ff764d'; 

                let avatarHtml;
                if (branding.profilePhotoUrl) {
                    avatarHtml = `<img src="${branding.profilePhotoUrl}" class="avatar-circle" style="object-fit:cover; width:50px; height:50px;">`;
                } else {
                    const initials = name ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'PL';
                    avatarHtml = `<div class="avatar-circle" style="background: ${baseColor}; color:white;">${initials}</div>`;
                }

                const card = document.createElement('div');
                card.className = 'founder-card';
                card.style.borderTop = `3px solid ${baseColor}`;
                card.innerHTML = `
                    ${avatarHtml}
                    <h3>${name}</h3>
                    <span class="flag">${country}</span>
                    <p>${bio}</p>
                `;
                gridContainer.appendChild(card);
            });

        } catch (error) {
            console.error(error);
            gridContainer.innerHTML = '<p style="color:#ff4d4d; text-align:center; grid-column:1/-1;">Error de conexi√≥n.</p>';
        }
    }

    btnOpen.addEventListener('click', (e) => {
        e.preventDefault();
        modal.style.display = 'flex';
        loadFounders();
    });

    btnClose.addEventListener('click', () => { modal.style.display = 'none'; });
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
  </script>

</body>
</html>