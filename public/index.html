<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>PianoLink ‚Äì Conexi√≥n MIDI remota</title>
    <style>
      :root {
        --bg-main: #f5f7fa;
        --primary: #1976d2;
        --primary-dark: #0d47a1;
        --accent: #ffc107;
        --text-main: #222222;
        --text-muted: #555555;
        --card-bg: #ffffff;
        
        --teacher-rgb: 33, 150, 243; /* Azul */
        --student-rgb: 255, 193, 7;  /* Amarillo */
      }

      * { box-sizing: border-box; }

      body {
        font-family: Arial, sans-serif;
        max-width: 960px;
        margin: 0 auto;
        padding: 20px 16px 40px;
        background: var(--bg-main);
        color: var(--text-main);
      }

      a { color: var(--primary-dark); text-decoration: none; }

      /* Header */
      .hero {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #ffffff;
        border-radius: 14px;
        padding: 18px 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }
      .hero-left { max-width: 520px; }
      .hero-title { margin: 0 0 4px; font-size: 26px; font-weight: bold; }
      .hero-subtitle { margin: 0 0 8px; font-size: 14px; color: #e3f2fd; }
      .hero-tagline { margin: 0 0 12px; font-size: 13px; color: #bbdefb; }
      .hero-badge {
        display: inline-block; font-size: 11px; padding: 4px 8px;
        border-radius: 999px; background: rgba(255, 255, 255, 0.16);
        border: 1px solid rgba(255, 255, 255, 0.35);
      }
      .hero-right {
        text-align: right; min-width: 160px;
        display: flex; flex-direction: column; align-items: flex-end; gap: 6px;
      }
      .hero-project { font-size: 12px; margin-bottom: 2px; opacity: 0.9; }

      .panic-btn {
        background: #d32f2f; color: white; border: 1px solid #b71c1c;
        font-size: 11px; padding: 4px 10px; border-radius: 4px; cursor: pointer;
        display: inline-flex; align-items: center; gap: 4px; transition: background 0.2s;
      }
      .panic-btn:hover { background: #b71c1c !important; }

      /* Status Badges */
      .status-badge {
        display: inline-block; padding: 4px 10px; border-radius: 99px;
        font-size: 11px; font-weight: bold; transition: all 0.3s ease; text-align: center;
      }
      .status-connected { background-color: #e6fffa; color: #047481; border: 1px solid #b2f5ea; }
      .status-disconnected { background-color: #fff5f5; color: #c53030; border: 1px solid #feb2b2; animation: pulse-red 2s infinite; }
      .status-connecting { background-color: #fffaf0; color: #c05621; border: 1px solid #fbd38d; }
      @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(229, 62, 62, 0); }
        100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
      }

      /* Cards */
      .card {
        background: var(--card-bg); border-radius: 10px; padding: 12px 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06); margin-bottom: 16px; border: 1px solid #dde3ec;
      }
      .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .section-title { margin: 0; font-size: 15px; color: var(--primary-dark); }
      .section { margin-bottom: 10px; }
      
      .role-help {
        font-size: 13px; background: #e8f1ff; border-left: 3px solid var(--primary);
        padding: 8px; margin-top: 6px; border-radius: 4px; color: #143a66;
      }
      .inline-help { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
      
      .log {
        border: 1px solid #d0d5de; height: 150px; padding: 8px; overflow-y: auto;
        white-space: pre-wrap; font-size: 12px; background: #fafbff; border-radius: 4px;
      }
      .note-box {
        border: 1px solid #d0d5de; padding: 6px; font-size: 14px; background: #ffffff; border-radius: 4px;
      }
      .hidden { display: none; }

      /* Controls */
      button {
        background: var(--primary); color: #ffffff; border: none; border-radius: 4px;
        padding: 6px 10px; font-size: 13px; cursor: pointer;
      }
      button:disabled { background: #b0bec5; cursor: default; }
      button:hover:not(:disabled) { background: var(--primary-dark); }
      
      input[type="text"], #codigoSala, #inviteLink {
        padding: 5px 7px; border-radius: 4px; border: 1px solid #c5cad3;
        font-size: 13px; min-width: 120px;
      }
      #inviteLink { width: 100%; }
      select { padding: 5px 7px; border-radius: 4px; border: 1px solid #c5cad3; font-size: 13px; }

      /* Piano */
      .piano-wrapper {
        border: 1px solid #999; overflow-x: auto; overflow-y: hidden;
        height: 180px; background: #dde1eb; border-radius: 4px;
      }
      .piano { position: relative; height: 100%; }
      .key {
        position: absolute; box-sizing: border-box; transition: transform 0.05s ease, background-color 0.05s ease;
      }
      .white-key {
        height: 100%; background: #ffffff; border: 1px solid #000; bottom: 0; z-index: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
      }
      .black-key {
        height: 55%; background: #000000; border: 1px solid #000; top: 0; z-index: 5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
      }
      .note-label {
        position: absolute; bottom: 2px; left: 2px; font-size: 8px; color: #333; pointer-events: none;
      }
      
      .white-key.active-teacher, .white-key.active-student {
        transform: translateY(4px); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .black-key.active-teacher, .black-key.active-student {
        transform: translateY(3px); box-shadow: inset 0 2px 3px rgba(255, 255, 255, 0.25);
      }

      .pedal-indicator {
        font-size: 11px; font-weight: bold; padding: 4px 10px; border-radius: 4px;
        background: #e0e0e0; color: #9e9e9e; border: 1px solid #bdbdbd; text-transform: uppercase;
      }
      .pedal-indicator.active {
        background: #4caf50; color: #ffffff; border-color: #388e3c; box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
      }

      .layout-grid { display: grid; grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr); gap: 16px; }
      @media (max-width: 768px) {
        .layout-grid { grid-template-columns: 1fr; }
        .hero, .hero-right { text-align: left; align-items: flex-start; }
      }
      .footer { margin-top: 18px; font-size: 11px; text-align: center; color: #777; }
    </style>
  </head>

  <body>
    <header class="hero">
      <div class="hero-left">
        <h1 class="hero-title">PianoLink</h1>
        <p class="hero-subtitle">Conexi√≥n MIDI remota en tiempo real.</p>
        <p class="hero-tagline">
          <span style="color: #ffc107; font-weight: bold;">‚ñ† Alumno (Amarillo)</span> | 
          <span style="color: #82b1ff; font-weight: bold;">‚ñ† Profesor (Azul)</span>
        </p>
      </div>
      <div class="hero-right">
        <div id="connectionStatus" class="status-badge status-connecting">Conectando...</div>
        <button id="panicBtn" class="panic-btn">üîá Reset / P√°nico</button>
        <div class="hero-project" style="margin-top:8px;">by Miguel Antonio</div>
      </div>
    </header>

    <div class="card" id="roleCard">
      <h2 class="section-title">1. Configuraci√≥n de entrada</h2>
      <div class="section">
        <label><input type="radio" name="rol" value="teacher" checked /> Profesor</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="rol" value="student" /> Alumno</label>
      </div>
      <div style="margin-top:10px; margin-bottom:10px;">
        <input type="text" id="inputName" placeholder="Tu Nombre (Ej: Juan)" style="width:100%; font-weight:bold;">
      </div>
      <div id="roleHelp" class="role-help"></div>
    </div>

    <div class="card" id="roomCard">
      <h2 class="section-title">2. Conectarse a la misma sala</h2>
      <div class="section">
        <button id="crearSala">Crear sala</button>
        <input id="codigoSala" placeholder="C√≥digo de sala" />
        <button id="unirseSala">Unirse</button>
        <div class="inline-help">El profesor crea la sala. El alumno se une con el c√≥digo.</div>
      </div>
      <div class="section" id="inviteSection">
        <h3 class="section-title">Link de invitaci√≥n</h3>
        <div style="margin-top:6px;">
          <input id="inviteLink" readonly placeholder="Crea una sala primero..." />
        </div>
        <div style="margin-top:6px;">
          <button id="copyInviteBtn">Copiar link</button>
        </div>
      </div>
    </div>

    <div class="layout-grid">
      <div>
        <div class="card" id="noteCard">
          <h2 class="section-title">3. Nota actual</h2>
          <div class="note-box" id="noteDisplay">‚Äî</div>
        </div>

        <div class="card" id="pianoCard">
          <div class="section-header">
            <h2 class="section-title">Piano visual</h2>
            <div id="sustainPedal" class="pedal-indicator">Sustain</div>
          </div>
          <div class="piano-wrapper"><div id="piano" class="piano"></div></div>
        </div>
      </div>

      <div>
        <div class="card" id="advancedCard">
          <h2 class="section-title">Opciones</h2>
          <div class="section">
            <label>Salida MIDI: <select id="midiOutputSelect"><option value="">(ninguna)</option></select></label>
          </div>
          <div class="section">
            <label><input type="checkbox" id="toggleMidiOut" /> Activar salida MIDI a mi teclado</label>
          </div>
        </div>

        <div class="card" id="logCard">
          <h2 class="section-title">Log</h2>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>

    <div class="footer">PianoLink ¬∑ Conexi√≥n MIDI remota</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      // Referencias DOM
      const inputName = document.getElementById("inputName"); // NUEVO
      const crearSala = document.getElementById("crearSala");
      const unirseSala = document.getElementById("unirseSala");
      const codigoSala = document.getElementById("codigoSala");
      const logDiv = document.getElementById("log");
      const toggleMidiOut = document.getElementById("toggleMidiOut");
      const midiOutputSelect = document.getElementById("midiOutputSelect");
      const piano = document.getElementById("piano");
      const roleHelp = document.getElementById("roleHelp");
      const noteDisplay = document.getElementById("noteDisplay");
      const advancedCard = document.getElementById("advancedCard");
      const logCard = document.getElementById("logCard");
      const inviteLinkInput = document.getElementById("inviteLink");
      const copyInviteBtn = document.getElementById("copyInviteBtn");
      const inviteSection = document.getElementById("inviteSection");
      const statusEl = document.getElementById("connectionStatus");
      const sustainPedalEl = document.getElementById("sustainPedal");
      const panicBtn = document.getElementById("panicBtn");

      const teacherRadio = document.querySelector('input[name="rol"][value="teacher"]');
      const studentRadio = document.querySelector('input[name="rol"][value="student"]');

      // Estado Global
      let rol = "teacher";
      let salaActual = null;
      let myName = "";
      let lockStudentFromLink = false;

      let midiAccessGlobal = null;
      let midiOutput = null;
      let midiOutputs = [];
      let enableMidiOut = false;
      const keyElementsByNote = {};

      // ===========================
      // 1. L√ìGICA DE SALAS (NUEVO)
      // ===========================

      // Bot√≥n CREAR
      crearSala.addEventListener("click", () => {
        const name = inputName.value.trim();
        if(!name) return alert("Por favor ingresa tu nombre primero.");
        
        myName = name;
        rol = "teacher";
        teacherRadio.checked = true;
        
        // Solicitar al servidor
        socket.emit("create-room", { username: name });
        log(`‚è≥ Solicitando nueva sala como Profesor...`);
      });

      // Respuesta del Servidor (Aqu√≠ se genera el link)
      socket.on("room-created", (code) => {
        salaActual = code;
        codigoSala.value = code; // Poner el c√≥digo en la caja
        log(`‚úÖ Sala creada con √©xito: ${code}`);
        updateInviteLink(); // Generar link
      });

      // Bot√≥n UNIRSE
      unirseSala.addEventListener("click", () => {
        const code = codigoSala.value.trim().toUpperCase();
        const name = inputName.value.trim();

        if(!name) return alert("Ingresa tu nombre.");
        if(!code) return alert("Ingresa el c√≥digo de la sala.");

        myName = name;
        salaActual = code;
        socket.emit("join-room", code);
        log(`‚è≥ Uni√©ndose a sala ${code} como ${rol}...`);
        updateInviteLink();
      });


      // ===========================
      // 2. STATUS Y LINKS
      // ===========================

      function updateStatus(state) {
        statusEl.className = "status-badge"; 
        if (state === "connected") {
          statusEl.classList.add("status-connected"); statusEl.textContent = "üü¢ Conectado";
        } else if (state === "disconnected") {
          statusEl.classList.add("status-disconnected"); statusEl.textContent = "üî¥ Desconectado";
        } else if (state === "connecting") {
          statusEl.classList.add("status-connecting"); statusEl.textContent = "üü° Conectando...";
        }
      }

      socket.on("connect", () => {
        updateStatus("connected");
        // Si se reconecta y ya ten√≠a sala, volver a unirse
        if (salaActual) socket.emit("join-room", salaActual);
      });
      socket.on("disconnect", () => updateStatus("disconnected"));
      socket.on("connect_error", () => updateStatus("disconnected"));

      setInterval(() => {
        if (socket.connected) socket.emit("ping_keep_alive"); // Mantener conexi√≥n activa
      }, 25000);

      function updateInviteLink() {
        if (rol !== "teacher" || !salaActual) {
          inviteLinkInput.value = "";
          return;
        }
        const url = new URL(window.location.href);
        url.searchParams.set("role", "student");
        url.searchParams.set("room", salaActual);
        inviteLinkInput.value = url.toString();
      }

      copyInviteBtn.addEventListener("click", () => {
        const value = inviteLinkInput.value.trim();
        if (!value) return alert("Crea una sala primero.");
        navigator.clipboard.writeText(value)
          .then(() => log("Link copiado al portapapeles."))
          .catch(() => log("Error copiando link."));
      });


      // ===========================
      // 3. UI Y ROLES
      // ===========================

      function updateRoleUI() {
        if (rol === "teacher") {
          roleHelp.textContent = "Modo Profesor: Ves tus notas en AZUL.";
          advancedCard.classList.remove("hidden");
          inviteSection.classList.remove("hidden");
        } else {
          roleHelp.textContent = "Modo Alumno: El profesor te ve en AMARILLO.";
          advancedCard.classList.remove("hidden");
          inviteSection.classList.add("hidden"); 
        }
      }

      document.querySelectorAll('input[name="rol"]').forEach((r) => {
        r.addEventListener("change", (e) => {
          if (lockStudentFromLink && e.target.value === "teacher") {
            studentRadio.checked = true; // Forzar alumno si vino por link
            return;
          }
          rol = e.target.value;
          updateRoleUI();
          updateInviteLink();
        });
      });

      // Autocompletar desde URL
      (function initFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const urlRole = params.get("role");
        const urlRoom = params.get("room");
        if (urlRole === "student") {
          rol = "student";
          if (studentRadio) studentRadio.checked = true;
          lockStudentFromLink = true;
          if (teacherRadio) teacherRadio.disabled = true;
        }
        if (urlRoom) {
          codigoSala.value = urlRoom;
          // No seteamos salaActual a√∫n, esperamos a que el usuario ponga nombre y click en Unirse
        }
        updateRoleUI();
      })();


      // ===========================
      // 4. MIDI ENGINE
      // ===========================

      function log(msg) {
        logDiv.textContent += msg + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(onMIDISuccess, () => log("‚ùå Sin soporte MIDI"));
      } else { log("‚ö†Ô∏è Navegador no soporta Web MIDI"); }

      function onMIDISuccess(midi) {
        midiAccessGlobal = midi;
        log("‚úÖ MIDI Activo");
        for (let input of midi.inputs.values()) {
          input.onmidimessage = handleMIDIMessageFromDevice;
        }
        midiOutputs = Array.from(midi.outputs.values());
        midiOutputSelect.innerHTML = '<option value="">(ninguna)</option>';
        midiOutputs.forEach((out, index) => {
          const opt = document.createElement("option");
          opt.value = index; opt.textContent = out.name;
          midiOutputSelect.appendChild(opt);
        });
      }

      toggleMidiOut.addEventListener("change", (e) => {
        enableMidiOut = e.target.checked;
        log("Salida MIDI: " + (enableMidiOut ? "ON" : "OFF"));
      });
      midiOutputSelect.addEventListener("change", (e) => {
        const idx = e.target.value;
        midiOutput = (idx !== "" && midiOutputs[idx]) ? midiOutputs[idx] : null;
      });

      // Procesar MIDI Local
      function handleMIDIMessageFromDevice(event) {
        const [status, data1, data2] = event.data;
        const command = status & 0xf0;

        // Visualizar localmente
        handleRemoteOrLocalNote({ type: "raw_midi", command, note: data1, velocity: data2, fromRole: rol });

        if (!salaActual) return; // No enviar si no hay sala

        // Enviar a la red
        if (command === 0x90 || command === 0x80) { 
          // Hack de canales para distinguir roles
          const targetChannel = rol === "teacher" ? 1 : 0;
          const outStatus = (command | targetChannel) & 0xff;
          socket.emit("midi-message", { roomCode: salaActual, message: { type: "note", command: outStatus, note: data1, velocity: data2, fromRole: rol } });
        } else if (command === 0xb0) { 
          socket.emit("midi-message", { roomCode: salaActual, message: { type: "cc", status, controller: data1, value: data2, fromRole: rol } });
        }
      }

      // Procesar MIDI Remoto
      socket.on("midi-message", (msg) => handleRemoteOrLocalNote(msg));

      function handleRemoteOrLocalNote(msg) {
        let cmd, note, velocity, role, type;
        if (msg.type === "raw_midi") {
             cmd = msg.command; note = msg.note; velocity = msg.velocity; role = msg.fromRole; type = "raw";
        } else if (msg.type === "note") {
             cmd = msg.command & 0xf0; note = msg.note; velocity = msg.velocity; role = msg.fromRole; type = "remote";
        } else {
             handleOtherMessages(msg); return;
        }

        const isNoteOn = (cmd === 0x90) && (velocity > 0);
        
        // Visualizaci√≥n
        const keyEl = keyElementsByNote[note];
        if (keyEl) {
            const activeClass = (role === "teacher") ? "active-teacher" : "active-student";
            if (isNoteOn) {
                const alpha = 0.3 + (velocity / 127) * 0.7;
                const baseRGB = (role === "teacher") ? "var(--teacher-rgb)" : "var(--student-rgb)";
                keyEl.classList.add(activeClass);
                keyEl.style.backgroundColor = `rgba(${baseRGB}, ${alpha})`;
            } else {
                keyEl.classList.remove("active-teacher", "active-student");
                keyEl.style.backgroundColor = "";
            }
        }

        if (isNoteOn && type !== "raw") {
             noteDisplay.textContent = `${role === "teacher" ? "PROFE" : "ALUMNO"}: ${noteNumberToName(note)}`;
        }

        // Salida de Audio (Filtrado Simple)
        if (type !== "raw") {
            const soyProfe = rol === "teacher";
            const vieneDeProfe = role === "teacher";
            const deboReproducir = enableMidiOut && midiOutput && ((soyProfe && !vieneDeProfe) || (!soyProfe && vieneDeProfe));
            
            if (deboReproducir) {
                try { midiOutput.send([isNoteOn?0x90:0x80, note, velocity]); } catch(e){}
            }
        }
      }

      function handleOtherMessages(msg) {
        if (msg.type === "raw_midi") { 
             if ((msg.command & 0xf0) === 0xb0 && msg.note === 64) updatePedalVisual(msg.velocity);
             return;
        }
        if (msg.type === "cc" && msg.controller === 64) updatePedalVisual(msg.value);
        
        // Replicar CC remoto si corresponde
        const soyProfe = rol === "teacher";
        const vieneDeProfe = msg.fromRole === "teacher";
        const deboReproducir = enableMidiOut && midiOutput && ((soyProfe && !vieneDeProfe) || (!soyProfe && vieneDeProfe));
        
        if (deboReproducir && msg.type === "cc") midiOutput.send([msg.status, msg.controller, msg.value]);
      }

      // Utils
      function updatePedalVisual(value) {
          sustainPedalEl.classList.toggle("active", value >= 64);
      }

      function noteNumberToName(note) {
        const names = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        return names[note % 12] + (Math.floor(note / 12) - 1);
      }

      // Construir Piano
      (function buildPiano() {
        const WHITE_KEYS = [0,2,4,5,7,9,11];
        const pianoDiv = document.getElementById("piano");
        pianoDiv.style.width = (52 * 26) + "px";
        let wIdx = 0;
        for (let i=21; i<=108; i++) {
          const isWhite = WHITE_KEYS.includes(i%12);
          const k = document.createElement("div");
          k.className = `key ${isWhite ? "white-key" : "black-key"}`;
          k.dataset.note = i;
          if (isWhite) {
            k.style.left = (wIdx * 26) + "px"; k.style.width = "26px";
            if (i%12===0) k.innerHTML = `<div class="note-label">${noteNumberToName(i)}</div>`;
            wIdx++;
          } else {
            k.style.left = ((wIdx-0.5)*26 - 8) + "px"; k.style.width = "16px";
          }
          pianoDiv.appendChild(k);
          keyElementsByNote[i] = k;
        }
      })();

      // Bot√≥n P√°nico
      panicBtn.addEventListener("click", () => {
        log("üîá P√°nico presionado");
        document.querySelectorAll(".key").forEach(k => {
           k.classList.remove("active-teacher", "active-student");
           k.style.backgroundColor = "";
        });
        updatePedalVisual(0);
        if (midiOutput) {
            for (let c=0; c<16; c++) midiOutput.send([0xB0|c, 123, 0]);
        }
      });
    </script>
  </body>
</html>