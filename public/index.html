<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Piano Link | Masterclass Studio Pro</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>

  <style>
    :root {
      /* Palette: Dark DAW (Ableton Inspired) */
      --bg: #1a1a1a;
      --panel: #262626;
      --panel-light: #303030;
      --border: #454545;
      --text-main: #dcdcdc;
      --text-muted: #909090;
      --accent: #ff764d; /* Ableton Orange */
      --accent-hover: #ff8f6e;
      --input-bg: #121212;
      --danger: #ff4d4d;
      --success: #b4e080;
      
      /* Teacher/Student Colors (Adjusted for Dark Mode) */
      --prof-color: #5dade2;
      --alum-color: #f1c40f;

      --radius: 4px;
      --spacing: 8px;
    }

    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--border) var(--bg);
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden; /* App-like feel */
      display: flex;
      flex-direction: column;
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Layout Principal */
    .app-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: 50px 1fr;
      height: 100%;
      width: 100%;
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }

    .brand {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-main);
    }
    
    .status-indicator {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
    }

    /* Sidebar (Settings & Participants) */
    .sidebar {
      background: var(--panel-light);
      border-right: 1px solid var(--border);
      padding: var(--spacing);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing);
    }

    /* Main Content (Piano & Board) */
    .main-stage {
      background: var(--bg);
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* UI Components: Panels */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
    }

    h2 {
      margin: 0 0 8px 0;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* Inputs & Controls */
    label {
      font-size: 11px;
      color: var(--text-main);
      display: block;
      margin-bottom: 4px;
    }

    input[type=text], select {
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 2px;
      width: 100%;
      outline: none;
    }
    input[type=text]:focus { border-color: var(--accent); }

    button {
      background: var(--border);
      color: var(--text-main);
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 11px;
      text-transform: uppercase;
      border-radius: 2px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.1s;
    }
    button:hover { background: #555; }
    button:active { transform: translateY(1px); }
    
    button.primary {
      background: var(--accent);
      color: #000;
    }
    button.primary:hover { background: var(--accent-hover); }

    button.danger {
      background: var(--danger);
      color: #fff;
    }

    /* Specific Sections in Sidebar */
    .config-row {
      margin-bottom: 10px;
    }
    
    .role-toggles label {
      display: inline-block;
      margin-right: 10px;
      cursor: pointer;
    }

    .invite-box {
      display: flex;
      gap: 4px;
      margin-top: 5px;
    }
    #inviteLink {
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 10px;
      padding: 4px;
      border-radius: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    /* Listas */
    .participants-list {
      max-height: 200px;
      overflow-y: auto;
      font-size: 11px;
      margin-top: 5px;
    }
    .participant-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
    }
    .participant-row:last-child { border-bottom: none; }
    
    .log-terminal {
      font-family: 'Consolas', monospace;
      font-size: 10px;
      background: #000;
      color: #0f0;
      border: 1px solid var(--border);
      height: 120px;
      overflow-y: auto;
      padding: 6px;
      opacity: 0.8;
    }

    /* --- PIANO SECTION --- */
    .piano-container {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
    }
    
    .piano-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--input-bg);
      padding: 3px 6px;
      border-radius: 2px;
    }

    /* Custom Color Picker Style */
    input[type=color] {
      -webkit-appearance: none;
      border: none;
      width: 16px;
      height: 16px;
      padding: 0;
      background: none;
      cursor: pointer;
    }
    input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type=color]::-webkit-color-swatch { border: 1px solid var(--border); border-radius: 2px; }

    /* Piano Scroll Wrapper */
    .piano-wrapper {
      position: relative;
      height: 140px;
      background: #111; /* Gap color */
      overflow-x: auto;
      overflow-y: hidden;
      border: 1px solid #000;
      border-top: 4px solid #333; /* Fallboard aesthetic */
      box-shadow: inset 0 0 10px #000;
    }

    .piano {
      position: relative;
      height: 100%;
    }

    .key {
      position: absolute;
      box-sizing: border-box;
      border-radius: 0 0 2px 2px;
      transition: background-color 0.05s ease; /* Solo color, sin transform */
    }

    /* Flat Design Piano Keys */
    .white-key {
      height: 100%;
      background: #cccccc;
      border: 1px solid #000;
      border-top: none;
      z-index: 1;
    }
    .white-key:hover { background: #dcdcdc; }

    .black-key {
      height: 60%;
      background: #111111;
      border: 1px solid #000;
      border-top: none;
      z-index: 10;
    }
    
    /* Active State Override (JS injects color) */
    .key.note-active {
        /* Eliminamos transform 3D para mantener estilo Flat */
    }

    /* Pedal & Badges */
    .pedal-bar {
      height: 6px;
      background: #333;
      margin-top: 8px;
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }
    .pedal-active {
      width: 100%;
      height: 100%;
      background: var(--success);
      opacity: 0;
      transition: opacity 0.1s;
    }
    #pedalIndicator.active .pedal-active { opacity: 1; }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 2px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .badge-live {
      background: #3a1c1c;
      color: var(--danger);
      border: 1px solid var(--danger);
      display: none;
    }
    .badge-live.visible { display: inline-block; }

    /* --- BOARD (PARTITURA) --- */
    .board-container {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0; /* Sin padding interno para maximizar espacio */
      display: flex;
      flex-direction: row;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    #staffContainer {
      background: #f0f0f0; /* Partitura siempre clara para contraste */
      min-width: 420px;
      height: 450px;
      border-right: 1px solid var(--border);
    }
    
    /* Chord Overlay */
    #chordDisplay {
      flex: 1;
      padding: 20px;
      font-size: 42px;
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      background: radial-gradient(circle at center, #2a2a2a 0%, #1a1a1a 100%);
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chord-placeholder {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    /* Helper Classes */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-2 { margin-top: 8px; }
    
    /* Responsive */
    @media (max-width: 900px) {
      .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
      }
      .board-container { flex-direction: column; }
      #staffContainer { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
      #chordDisplay { width: 100%; height: 100px; }
      .sidebar { border-right: none; border-bottom: 1px solid var(--border); max-height: 250px; }
    }
  </style>
</head>

<body>

  <div class="app-container">
    <header class="header">
      <div class="brand">
        üéπ Piano Link <span style="color:var(--accent)">// STUDIO PRO</span>
      </div>
      <div id="status" class="status-indicator">Desconectado</div>
    </header>

    <aside class="sidebar">
      
      <div class="panel">
        <h2>Identidad</h2>
        <div class="config-row">
          <input type="text" id="inputName" placeholder="Tu Nombre" />
        </div>
        <div class="role-toggles">
          <label id="teacherRoleLabel"><input type="radio" name="rol" value="teacher" checked> Profesor</label>
          <label><input type="radio" name="rol" value="student"> Alumno</label>
        </div>
        <div id="roleIndicator" class="badge" style="background:var(--prof-color); color:#000; text-align:center; margin-top:4px;">Profesor</div>
      </div>

      <div class="panel">
        <h2>Sesi√≥n</h2>
        <div id="cardCrearSala">
          <button id="btnCrear" class="primary" style="width:100%">Crear Sala Nueva</button>
          <div class="invite-box">
            <div id="inviteLink">Esperando sala...</div>
            <button id="copyLinkBtn">Copiar</button>
          </div>
          <div id="copyStatus" style="font-size:10px; margin-top:4px; color:var(--success);"></div>
        </div>

        <div id="cardUnirseSala" style="display:none;">
          <div style="display:flex; gap:4px;">
            <input type="text" id="codigoSala" maxlength="4" placeholder="C√ìDIGO" style="text-transform:uppercase; text-align:center; letter-spacing:2px; font-weight:bold;">
            <button id="btnUnirse" class="primary">Unirse</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>MIDI I/O</h2>
        
        <div class="config-row">
          <label>Entrada (Teclado):</label>
          <select id="midiInputSelect" style="width:100%">
              <option value="">(Silencio - Seguro)</option>
          </select>
        </div>

        <div class="config-row">
          <label>Salida (Sonido):</label>
          <select id="midiOutputSelect" style="width:100%">
              <option value="">(ninguna)</option>
          </select>
        </div>
        
        <label><input type="checkbox" id="toggleMidiOut"> Enviar a mi sintetizador</label>
      </div>

      <div class="panel" id="participantsCard">
        <h2>Participantes</h2>
        <div id="participantsList" class="participants-list">
          <div style="color:var(--text-muted); font-size:10px;">Esperando conexiones...</div>
        </div>
      </div>

      <div class="panel" style="flex:1; display:flex; flex-direction:column; min-height:100px;">
        <h2>System Log</h2>
        <div id="log" class="log-terminal"></div>
      </div>

    </aside>

    <main class="main-stage">
      
      <div class="board-container">
        <div id="staffContainer"></div>
        <div id="chordDisplay">
          <span class="chord-placeholder">--</span>
        </div>
      </div>

      <div class="piano-container">
        
        <div class="piano-toolbar">
            <div class="toolbar-group">
                <label for="baseColorPicker">Color:</label>
                <input type="color" id="baseColorPicker" value="#ff764d"> </div>

            <div class="toolbar-group">
                <label><input type="checkbox" id="chkSplit"> Split</label>
            </div>

            <div id="splitControls" class="toolbar-group hidden">
                <label>Key:</label>
                <input type="number" id="splitPointInput" value="60" min="21" max="108" style="width:40px;">
                <label>L:</label>
                <input type="color" id="leftColorPicker" value="#5dade2">
                <label>R:</label>
                <input type="color" id="rightColorPicker" value="#f1c40f">
            </div>

            <div style="flex:1"></div>

            <div id="liveStatus" style="font-size:10px; color:var(--text-muted); margin-right:10px;"></div>
            <span id="liveBadge" class="badge badge-live">EN VIVO</span>
            
            <button id="panicBtn" class="danger">PANIC</button>
        </div>

        <div class="piano-wrapper">
          <div id="piano" class="piano"></div>
        </div>

        <div id="pedalIndicator" class="pedal-bar">
            <div class="pedal-active"></div>
            <div id="pedalIndicator-dot" style="display:none"></div> 
        </div>
        <div style="text-align:center; font-size:9px; color:var(--text-muted); margin-top:2px;">SUSTAIN</div>

      </div>

    </main>
  </div>

  <script>
    const socket = io();

    // DOM References
    const statusDiv = document.getElementById("status");
    const inputName = document.getElementById("inputName");
    const codigoSala = document.getElementById("codigoSala");
    const btnCrear = document.getElementById("btnCrear");
    const btnUnirse = document.getElementById("btnUnirse");
    const inviteLink = document.getElementById("inviteLink");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const copyStatus = document.getElementById("copyStatus");
    const roleIndicator = document.getElementById("roleIndicator");
    const liveStatus = document.getElementById("liveStatus");
    const liveBadge = document.getElementById("liveBadge");
    const piano = document.getElementById("piano");
    const pedalIndicator = document.getElementById("pedalIndicator");
    const panicBtn = document.getElementById("panicBtn");

    const participantsList = document.getElementById("participantsList");
    const logDiv = document.getElementById("log");
    const toggleMidiOut = document.getElementById("toggleMidiOut");
    const midiOutputSelect = document.getElementById("midiOutputSelect");
    const masterclassSection = document.getElementById("masterclassSection");
    const masterclassToggle = document.getElementById("masterclassToggle");
    const clearLiveBtn = document.getElementById("clearLiveBtn");
    const teacherRoleLabel = document.getElementById("teacherRoleLabel");
    
    const chordDisplay = document.getElementById("chordDisplay");
    const staffContainer = document.getElementById("staffContainer");

    // Logic Vars


    let rol = "teacher";
    let myName = "";
    let salaActual = null;
    let mySocketId = null;

    let participants = [];
    let listeningTo = new Set();
    let liveStudentId = null;
    let masterclassEnabled = false;

    let midiOutput = null;
    let midiAccess = null;
    let enableMidiOut = false;

    let lockStudentRole = false;
    let lastPedalTime = 0; // <--- AGREGA ESTO

    // Board Logic
    let teacherActiveNotes = new Set();
    let heldNotes = new Set();
    let sustainActive = false;
    let renderTimeout = null; // [MEJORA 4: DEBOUNCE]

    /* ------------ UTILIDADES UI (LOG MEJORADO) ------------ */

    // [MEJORA 1: LOG MEJORADO] Timestamp + Colores
    function log(msg, type = 'info') {
      const el = document.createElement("div");
      
      const time = new Date().toLocaleTimeString([], { hour12: false });
      el.textContent = `[${time}] ${msg}`;
      
      if (type === 'error') el.style.color = 'var(--danger)';
      else if (type === 'warn') el.style.color = '#f1c40f';
      else if (type === 'success') el.style.color = 'var(--success)';
      
      logDiv.appendChild(el);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(msg) {
      statusDiv.textContent = msg;
    }

    function getInviteUrl() {
      if (!salaActual) return "";
      return window.location.origin + "/?role=student&sala=" + salaActual;
    }

    function updateInviteLink() {
      if (!salaActual) {
        inviteLink.textContent = "Esperando sala...";
        return;
      }
      const url = getInviteUrl();
      inviteLink.textContent = url;
    }

    function updateRoleIndicator() {
      if (rol === "teacher") {
        roleIndicator.textContent = "PROFESOR";
        roleIndicator.style.background = "var(--prof-color)";
        roleIndicator.style.color = "#000";
      } else {
        roleIndicator.textContent = "ALUMNO";
        roleIndicator.style.background = "var(--alum-color)";
        roleIndicator.style.color = "#000";
      }
    }

    function updateLiveBadge() {
      if (!liveBadge) return;
      if (rol === "student" && masterclassEnabled && liveStudentId === mySocketId) {
        liveBadge.classList.add("visible");
      } else {
        liveBadge.classList.remove("visible");
      }
    }

    function updateLiveStatusUI() {
      if (!liveStatus) return;

      if (rol === "teacher") {
        if (masterclassEnabled && liveStudentId) {
          liveStatus.textContent = "BROADCAST ACTIVO";
          liveStatus.style.color = "var(--danger)";
        } else {
          liveStatus.textContent = "MONITORIZACI√ìN LOCAL";
          liveStatus.style.color = "var(--text-muted)";
        }
      } else {
        if (masterclassEnabled && liveStudentId === mySocketId) {
          liveStatus.textContent = "EST√ÅS EN EL AIRE";
          liveStatus.style.color = "var(--danger)";
        } else if (masterclassEnabled && liveStudentId) {
          liveStatus.textContent = "ESCUCHANDO COMPA√ëERO";
          liveStatus.style.color = "var(--text-muted)";
        } else {
          liveStatus.textContent = "PRACTICA LOCAL";
          liveStatus.style.color = "var(--text-muted)";
        }
      }
      updateLiveBadge();
    }

    /* ------------ SOCKET.IO (MEJORADO) ------------ */

    socket.on("connect", () => {
      mySocketId = socket.id;
      updateStatus("ONLINE ‚úîÔ∏è");

      // [MEJORA 2: RECONEXI√ìN AUTOM√ÅTICA]
      if (salaActual && myName) {
        log(`üîÑ Reconexi√≥n detectada. Reingresando a sala ${salaActual}...`, 'warn');
        socket.emit("join-room", { 
            roomCode: salaActual, 
            username: myName, 
            userRole: rol 
        });
      } else {
        log("üü¢ Conectado al servidor.", 'success');
      }
    });

    socket.on("disconnect", (reason) => {
      updateStatus("OFFLINE ‚ùå");
      log(`üî¥ Desconectado: ${reason}`, 'error');
    });

    socket.on("connect_error", (err) => {
      updateStatus("RETRYING...");
      log(`‚ö†Ô∏è Error de conexi√≥n: ${err.message}`, 'warn');
    });

    socket.on("room-users", (users) => {
      participants = users || [];
      renderParticipants();
    });

    socket.on("live-student-changed", (payload) => {
      liveStudentId = payload && payload.liveStudentId ? payload.liveStudentId : null;
      masterclassEnabled = !!liveStudentId;

      if (rol === "teacher" && masterclassToggle) {
        masterclassToggle.checked = masterclassEnabled;
      }

      renderParticipants();
      updateLiveStatusUI();
    });

    socket.on("midi-message", (msg) => {
      handleRemoteOrLocalNote(msg);
    });
    // En index.html (dentro del script)

    socket.on("room-joined", (code) => {
      salaActual = code;
      log("‚úÖ Te has unido correctamente a la sala " + code, 'success');
      updateStatus("EN SALA: " + code);

      // --- NUEVO: PEDIR ESTADO ACTUAL DE LA PIZARRA ---
      log("üîÑ Sincronizando pizarra...", 'warn');
      socket.emit("request-full-state", code);
      // ------------------------------------------------

      if (rol === "student") {
          const btn = document.getElementById("btnUnirse");
          const input = document.getElementById("codigoSala");
          if(btn) {
              btn.textContent = "DENTRO";
              btn.disabled = true;
              btn.style.background = "var(--success)";
              btn.style.color = "#000";
          }
          if(input) input.disabled = true;
      }
    });
    /* ------------ BOT√ìN COPIAR ENLACE ------------ */

    copyLinkBtn.addEventListener("click", async () => {
      const url = getInviteUrl();
      if (!url) {
        copyStatus.style.color = "var(--danger)";
        copyStatus.textContent = "Crea una sala primero.";
        setTimeout(() => (copyStatus.textContent = ""), 2500);
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
        } else {
          const temp = document.createElement("textarea");
          temp.value = url;
          document.body.appendChild(temp);
          temp.select();
          document.execCommand("copy");
          document.body.removeChild(temp);
        }
        copyStatus.style.color = "var(--success)";
        copyStatus.textContent = "Copiado.";
      } catch (e) {
        copyStatus.textContent = "Error al copiar.";
      }
      setTimeout(() => (copyStatus.textContent = ""), 2500);
    });

    /* ------------ SELECCI√ìN DE ROL ------------ */

    document.querySelectorAll("input[name=rol]").forEach(radio => {
      radio.addEventListener("change", () => {
        const requestedRole = radio.value;
        if (lockStudentRole && requestedRole === "teacher") {
          document.querySelector('input[name=rol][value="student"]').checked = true;
          rol = "student";
        } else if (radio.checked) {
          rol = requestedRole;
        }

        document.getElementById("cardCrearSala").style.display =
          (rol === "teacher") ? "block" : "none";
        document.getElementById("cardUnirseSala").style.display =
          (rol === "teacher") ? "none" : "block";

        if (masterclassSection) {
          masterclassSection.style.display = (rol === "teacher") ? "block" : "none";
        } else if(rol === "teacher") {
             document.getElementById("masterclassSection").classList.remove("hidden");
        } else {
             document.getElementById("masterclassSection").classList.add("hidden");
        }

        updateRoleIndicator();
        updateLiveStatusUI();
      });
    });

    if (rol === "teacher") {
        if(masterclassSection) masterclassSection.classList.remove("hidden");
        document.getElementById("cardCrearSala").style.display = "block";
        document.getElementById("cardUnirseSala").style.display = "none";
    }

    updateRoleIndicator();
    updateLiveStatusUI();

    /* ------------ PARTICIPANTES ------------ */

    function renderParticipants() {
      participantsList.innerHTML = "";
      if (!participants.length) {
        const d = document.createElement("div");
        d.style.color = "var(--text-muted)";
        d.textContent = "Nadie conectado.";
        participantsList.appendChild(d);
        return;
      }

      const soyProfe = (rol === "teacher");

      participants.forEach(u => {
        const row = document.createElement("div");
        row.className = "participant-row";

        const left = document.createElement("div");
        const n = document.createElement("span");
        n.style.fontWeight = "bold";
        n.textContent = u.name;
        const r = document.createElement("span");
        r.style.marginLeft = "6px";
        r.style.fontSize = "10px";
        r.style.color = "var(--text-muted)";
        r.textContent = (u.role === "teacher" ? "[PROFE]" : "[ALUMNO]");
        left.appendChild(n);
        left.appendChild(r);

        const right = document.createElement("div");

        if (soyProfe && u.role !== "teacher" && u.socketId !== mySocketId) {
          // Checkbox "Escuchar"
          const listenLabel = document.createElement("label");
          listenLabel.style.display="inline"; 
          listenLabel.style.marginRight="8px";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = (listeningTo.size === 0) || listeningTo.has(u.socketId);
          cb.addEventListener("change", () => toggleListen(u.socketId, cb.checked));
          listenLabel.appendChild(cb);
          listenLabel.appendChild(document.createTextNode(" CUE"));
          right.appendChild(listenLabel);

          // Radio "En Vivo"
          const liveLabel = document.createElement("label");
          liveLabel.style.display="inline";
          const rb = document.createElement("input");
          rb.type = "radio";
          rb.name = "liveStudent";
          rb.checked = (liveStudentId === u.socketId);
          rb.addEventListener("change", () => {
            if (rb.checked) {
              masterclassToggle.checked = true;
              sendLiveStudent(u.socketId);
            }
          });
          liveLabel.appendChild(rb);
          liveLabel.appendChild(document.createTextNode(" ON AIR"));
          right.appendChild(liveLabel);
        } else if (u.socketId === mySocketId) {
          right.textContent = " (T√∫)";
          right.style.fontSize = "10px";
          right.style.color = "var(--text-muted)";
        }

        row.appendChild(left);
        row.appendChild(right);
        participantsList.appendChild(row);
      });
    }

    function toggleListen(id, checked) {
      if (checked) listeningTo.add(id);
      else listeningTo.delete(id);
    }

    function sendLiveStudent(studentSocketId) {
      if (!salaActual) return;
      liveStudentId = studentSocketId || null;
      masterclassEnabled = !!liveStudentId;
      socket.emit("set-live-student", {
        roomCode: salaActual,
        studentSocketId: liveStudentId
      });
      updateLiveStatusUI();
      renderParticipants();
    }

    if (masterclassToggle) {
      masterclassToggle.addEventListener("change", () => {
        if (!masterclassToggle.checked) {
          sendLiveStudent(null);
        } else {
          if (liveStudentId) sendLiveStudent(liveStudentId);
        }
      });
    }

    if (clearLiveBtn) {
      clearLiveBtn.addEventListener("click", () => {
        sendLiveStudent(null);
        if (masterclassToggle) masterclassToggle.checked = false;
      });
    }

    /* ------------ CREAR / UNIR SALA ------------ */

    btnCrear.addEventListener("click", () => {
      const name = inputName.value.trim();
      if (!name) return alert("Ingresa tu nombre.");
      myName = name;
      socket.emit("create-room", { username: name, userRole: "teacher" });
      log("Creando sala...");
    });

    socket.on("room-created", (roomCode) => {
      salaActual = roomCode;
      codigoSala.value = roomCode; 
      updateInviteLink();
      log("Sala ID: " + roomCode, 'success');
    });

    btnUnirse.addEventListener("click", () => {
      const name = inputName.value.trim();
      if (!name) return alert("Ingresa tu nombre.");
      const code = codigoSala.value.trim().toUpperCase();
      if (!code) return alert("Ingresa el c√≥digo.");
      myName = name;
      salaActual = code;
      socket.emit("join-room", { roomCode: code, username: name, userRole: rol });
      log("Uni√©ndose a " + code + "...");
    });

    /* ------------ INICIALIZAR DESDE URL ------------ */

    (function initFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        const urlRole = params.get("role");
        const urlSala = params.get("sala") || params.get("room");

        if (urlSala) {
          salaActual = urlSala.toUpperCase();
          codigoSala.value = salaActual; 
        }

        if (urlRole && urlRole.toLowerCase() === "student") {
          rol = "student";
          lockStudentRole = true;
          const studentRadio = document.querySelector('input[name="rol"][value="student"]');
          const teacherRadio = document.querySelector('input[name="rol"][value="teacher"]');
          if (studentRadio) studentRadio.checked = true;
          if (teacherRadio) {
            teacherRadio.checked = false;
            teacherRadio.disabled = true;
          }
          if (teacherRoleLabel) teacherRoleLabel.style.display = "none";

          document.getElementById("cardCrearSala").style.display = "none";
          document.getElementById("cardUnirseSala").style.display = "block";
          if (masterclassSection) masterclassSection.classList.add("hidden");
        }

        updateRoleIndicator();
        updateLiveStatusUI();
      } catch (e) {
        console.warn("URL Params Error", e);
      }
    })();

   /* ------------ WEB MIDI (CON PROTECCI√ìN DE BUCLE) ------------ */

   const midiInputSelect = document.getElementById("midiInputSelect");
    let activeInput = null;

    if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess().then(onMIDISuccess, err => {
        log("MIDI Access Error: " + err, 'error');
      });
    } else {
      log("Browser MIDI not supported.", 'warn');
    }

    function onMIDISuccess(access) {
      midiAccess = access;
      refreshDevices();
      
      access.onstatechange = (e) => {
        // Solo refrescar si cambia la conexi√≥n f√≠sica
        if (e.port.state === "connected" || e.port.state === "disconnected") {
            refreshDevices();
        }
      };
    }

    function refreshDevices() {
      if (!midiAccess) return;

      // 1. Llenar Select de SALIDAS
      const currentOut = midiOutputSelect.value;
      midiOutputSelect.innerHTML = '<option value="">(ninguna)</option>';
      for (let output of midiAccess.outputs.values()) {
        const opt = document.createElement("option");
        opt.value = output.id;
        opt.textContent = output.name;
        midiOutputSelect.appendChild(opt);
      }
      if (currentOut) midiOutputSelect.value = currentOut;

      // 2. Llenar Select de ENTRADAS (¬°Aqu√≠ est√° la protecci√≥n!)
      const currentIn = midiInputSelect.value;
      // Eliminamos la opci√≥n autom√°tica "Todas". Ahora el usuario DEBE elegir.
      midiInputSelect.innerHTML = '<option value="">(Selecciona tu Piano...)</option>';
      
      for (let input of midiAccess.inputs.values()) {
        const opt = document.createElement("option");
        opt.value = input.id;
        opt.textContent = input.name;
        midiInputSelect.appendChild(opt);
      }
      if (currentIn) midiInputSelect.value = currentIn;
      
      updateInputListener();
    }

    // Cuando el usuario cambia la entrada en el men√∫
    midiInputSelect.addEventListener("change", updateInputListener);

    function updateInputListener() {
        if (!midiAccess) return;
        
        // 1. Desconectar todo lo anterior (Romper el bucle)
        for (let input of midiAccess.inputs.values()) {
            input.onmidimessage = null; 
        }

        const selectedId = midiInputSelect.value;
        const selectedName = midiInputSelect.options[midiInputSelect.selectedIndex]?.text;

        if (selectedId) {
            const input = midiAccess.inputs.get(selectedId);
            if (input) {
                // PROTECCI√ìN EXTRA: Si eliges el IAC Driver como entrada, te avisamos
                if (selectedName.includes("IAC") || selectedName.includes("loopMIDI")) {
                    log("‚ö†Ô∏è CUIDADO: Has seleccionado un cable virtual como entrada.", "warn");
                }

                input.onmidimessage = handleLocalMIDIMessage;
                log(`MIDI In: Escuchando solo a [${input.name}]`, 'success');
            }
        } else {
            log("MIDI In: Desactivado.", 'warn');
        }
    }

    midiOutputSelect.addEventListener("change", () => {
      const id = midiOutputSelect.value;
      midiOutput = id ? midiAccess.outputs.get(id) : null;
    });

    toggleMidiOut.addEventListener("change", () => {
      enableMidiOut = toggleMidiOut.checked;
      if (enableMidiOut) log("Salida MIDI activada.", "info");
      else log("Salida MIDI desactivada.", "info");
    });
    /* ------------ PIANO VISUAL (REESCRITO MATEM√ÅTICAMENTE) ------------ */

    let currentBaseColor = "#ff764d"; // Matches CSS Accent
    let isSplitActive = false;
    let splitPoint = 60; 
    let currentLeftColor = "#5dade2";
    let currentRightColor = "#f1c40f";

    const baseColorPicker = document.getElementById("baseColorPicker");
    const chkSplit = document.getElementById("chkSplit");
    const splitControlsDiv = document.getElementById("splitControls");
    const splitPointInput = document.getElementById("splitPointInput");
    const leftColorPicker = document.getElementById("leftColorPicker");
    const rightColorPicker = document.getElementById("rightColorPicker");

    if(baseColorPicker) baseColorPicker.addEventListener("input", (e) => currentBaseColor = e.target.value);
    if(chkSplit) {
      chkSplit.addEventListener("change", (e) => {
        isSplitActive = e.target.checked;
        if(isSplitActive) splitControlsDiv.classList.remove("hidden");
        else splitControlsDiv.classList.add("hidden");
      });
    }
    if(splitPointInput) splitPointInput.addEventListener("input", (e) => splitPoint = parseInt(e.target.value));
    if(leftColorPicker) leftColorPicker.addEventListener("input", (e) => currentLeftColor = e.target.value);
    if(rightColorPicker) rightColorPicker.addEventListener("input", (e) => currentRightColor = e.target.value);

    buildPiano();

    function buildPiano() {
      // MEJORA MATEM√ÅTICA: Anchos fijos y c√°lculo relativo a teclas blancas
      const WHITE_KEY_WIDTH = 24; 
      const BLACK_KEY_WIDTH = 14; 
      
      piano.innerHTML = "";
      
      // Total white keys from 21 (A0) to 108 (C8) is 52.
      // Width = 52 * 24 = 1248px + padding
      piano.style.width = ((52 * WHITE_KEY_WIDTH) + 20) + "px";

      let whiteKeyIndex = 0;

      for (let note = 21; note <= 108; note++) {
        // Pattern of MIDI notes starting at C (0): W, B, W, B, W, W, B, W, B, W, B, W
        // A0 is 21. 21 % 12 = 9 (A). 
        // Indices in octave: 0=C, 1=C#, 2=D, 3=D#, 4=E, 5=F, 6=F#, 7=G, 8=G#, 9=A, 10=A#, 11=B
        const octaveIndex = note % 12;
        const isWhite = [0, 2, 4, 5, 7, 9, 11].includes(octaveIndex);

        const key = document.createElement("div");
        key.dataset.note = note;

        if (isWhite) {
            key.className = "key white-key";
            key.style.left = (whiteKeyIndex * WHITE_KEY_WIDTH) + "px";
            key.style.width = WHITE_KEY_WIDTH + "px";
            whiteKeyIndex++;
        } else {
            key.className = "key black-key";
            // LOGICA: La tecla negra va entre la tecla blanca anterior (whiteKeyIndex - 1)
            // y la actual (que se dibujar√° despu√©s).
            // Posici√≥n borde derecho tecla blanca anterior: (whiteKeyIndex * WHITE_KEY_WIDTH)
            // Restamos mitad del ancho negro para centrar.
            key.style.left = ((whiteKeyIndex * WHITE_KEY_WIDTH) - (BLACK_KEY_WIDTH / 2)) + "px";
            key.style.width = BLACK_KEY_WIDTH + "px";
        }
        piano.appendChild(key);
      }
    }

    function hexToRgb(hex) {
      const bigint = parseInt(hex.replace('#', ''), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r},${g},${b}`;
    }

    function lightKey(note, on = true, velocity = 127) {
      // Busca el elemento HTML de la tecla correspondiente
      const k = piano.querySelector(`.key[data-note='${note}']`);
      if (!k) return;

      if (on) {
        // 1. Determinar el color base (Split o Normal)
        let targetHex = currentBaseColor;
        if (isSplitActive) {
            targetHex = (note < splitPoint) ? currentLeftColor : currentRightColor;
        }

        // 2. C√ÅLCULO DE OPACIDAD (Aqu√≠ est√° la magia)
        // velocity va de 0 a 127.
        // Math.pow hace que la curva sea exponencial, no lineal.
        // Esto exagera el efecto: si tocas suave, ser√° MUY transparente.
        // Si tocas fuerte, ser√° totalmente s√≥lido.
        let alpha = Math.pow(velocity / 127, 2); 

        // Limites de seguridad para que siempre se vea algo (m√≠nimo 0.15)
        if (alpha < 0.15) alpha = 0.15; 
        if (alpha > 1.0) alpha = 1.0;

        const rgb = hexToRgb(targetHex);

        // 3. Aplicar el color
        k.classList.add("note-active");
        // El color se pinta sobre la tecla. 
        // Alpha bajo = Se ve el color de fondo de la tecla (Blanco/Negro) = "Claro"
        // Alpha alto = Se ve el color naranja a tope = "Oscuro/S√≥lido"
        k.style.backgroundColor = `rgba(${rgb}, ${alpha})`; 
      } else {
        // Al soltar la tecla, quitamos el color y la clase
        k.classList.remove("note-active");
        k.style.backgroundColor = ""; 
      }
    }

    function updatePedalVisual(value) {
      const active = value >= 64;
      if (!pedalIndicator) return;
      if (active) pedalIndicator.classList.add("active");
      else pedalIndicator.classList.remove("active");
    }

    function handleTeacherPedal(value) {
      const isDown = value >= 64;
      sustainActive = isDown;
      if (!isDown) {
        teacherActiveNotes = new Set(heldNotes);
        // [MEJORA 4: DEBOUNCE EN PEDAL]
        if (renderTimeout) clearTimeout(renderTimeout);
        renderTimeout = setTimeout(() => {
          renderMusicBoard();
        }, 50);
      }
    }

    /* ------------ MIDI REMOTO ------------ */

    function handleRemoteOrLocalNote(msg) {
      let cmd, note, velocity, role, type, fromSocketId = msg.fromSocketId || null;

      // [MEJORA 3: FILTRO ANTI-R√ÅFAGA RECEPTOR]
      if (msg.timestamp) {
          const latency = Date.now() - msg.timestamp;
          if (latency > 2000) {
              log(`‚õî R√ÅFAGA BLOQUEADA: Datos viejos (${latency}ms).`, 'error');
              return; // Ignorar esta nota vieja
          }
          if (latency > 300) {
              log(`‚ö†Ô∏è Lag alto: ${latency}ms`, 'warn');
          }
      }

      if (msg.type === "raw_midi") {
        cmd = msg.command; note = msg.note; velocity = msg.velocity; role = msg.fromRole; type = "raw";
      } else if (msg.type === "note") {
        cmd = msg.command & 0xf0; note = msg.note; velocity = msg.velocity; role = msg.fromRole; type = "remote";
      } else {
        return handleOtherMessages(msg);
      }

      const isNoteOn = (cmd === 0x90 && velocity > 0);
      lightKey(note, isNoteOn, velocity);

      if (role === 'teacher') updateMusicBoard(note, isNoteOn);

      const soyProfe = (rol === "teacher");
      const vieneDeProfe = (role === "teacher");
      let deboReproducir = false;

      if (enableMidiOut && midiOutput) {
        if (soyProfe) {
          if (!vieneDeProfe) deboReproducir = true;
        } else {
          if (vieneDeProfe) deboReproducir = true;
          else if (masterclassEnabled && liveStudentId && fromSocketId === liveStudentId && fromSocketId !== mySocketId) {
            deboReproducir = true;
          }
        }
      }

      if (soyProfe && !vieneDeProfe && deboReproducir) {
        if (listeningTo.size > 0 && fromSocketId && !listeningTo.has(fromSocketId)) deboReproducir = false;
      }

      if (deboReproducir) {
        try { midiOutput.send([isNoteOn ? 0x90 : 0x80, note, velocity]); } catch (e) {}
      }
    }

    function handleOtherMessages(msg) {
      if (msg.type === "raw_midi") {
        if ((msg.command & 0xf0) === 0xb0 && msg.note === 64) updatePedalVisual(msg.velocity);
        return;
      }
      if (msg.type === "cc" && msg.controller === 64) {
        updatePedalVisual(msg.value);
        if (msg.fromRole === 'teacher') handleTeacherPedal(msg.value);
      }

      const soyProfe = (rol === "teacher");
      const vieneDeProfe = (msg.fromRole === "teacher");
      const fromSocketId = msg.fromSocketId || null;
      let deboReproducir = false;

      if (enableMidiOut && midiOutput) {
        if (soyProfe) {
          if (!vieneDeProfe) deboReproducir = true;
        } else {
          if (vieneDeProfe) deboReproducir = true;
          else if (masterclassEnabled && liveStudentId && fromSocketId === liveStudentId && fromSocketId !== mySocketId) {
            deboReproducir = true;
          }
        }
      }

      if (soyProfe && !vieneDeProfe && deboReproducir) {
        if (listeningTo.size > 0 && fromSocketId && !listeningTo.has(fromSocketId)) deboReproducir = false;
      }

      if (deboReproducir && msg.type === "cc") {
        midiOutput.send([msg.status, msg.controller, msg.value]);
      }
    }

    panicBtn.addEventListener("click", () => {
      teacherActiveNotes.clear();
      heldNotes.clear();
      sustainActive = false;
      
      // Forzar renderizado inmediato en Panic
      if(renderTimeout) clearTimeout(renderTimeout);
      renderMusicBoard();

      if (midiOutput) {
        for (let n = 0; n < 128; n++) midiOutput.send([0x80, n, 0]);
      }
      updatePedalVisual(0);
      log("Panic: RESET", 'warn');
    });

    /* ------------ PIZARRA MUSICAL (VexFlow + DEBOUNCE + ROBUST CHORD) ------------ */

    function updateMusicBoard(note, isNoteOn) {
      if (isNoteOn) {
        heldNotes.add(note); teacherActiveNotes.add(note);
      } else {
        heldNotes.delete(note);
        if (!sustainActive) teacherActiveNotes.delete(note);
      }
      
      // [MEJORA 4: DEBOUNCE] Esperar 50ms antes de renderizar
      if (renderTimeout) {
          clearTimeout(renderTimeout);
      }

      renderTimeout = setTimeout(() => {
          renderMusicBoard();
      }, 50);
    }
    
    function getMidiNameSharp(midi) {
        let noteName = Tonal.Note.fromMidi(midi);
        if (noteName.includes("b")) noteName = Tonal.Note.enharmonic(noteName);
        return noteName;
    }

    function renderMusicBoard() {
      const notesArray = Array.from(teacherActiveNotes).sort((a, b) => a - b);
      
      if (notesArray.length === 0) {
        chordDisplay.innerHTML = '<span class="chord-placeholder">--</span>';
        drawEmptyStaff();
        return;
      }

      const noteNames = notesArray.map(n => getMidiNameSharp(n));
      
      // [MEJORA 5: ROBUSTEZ DE ACORDES]
      // Paso A: Detectar con todas las notas
      let detectedChords = Tonal.Chord.detect(noteNames);
      
      // Paso B: Fallback - Si falla y hay muchas notas, probar con las primeras 4
      if ((!detectedChords || detectedChords.length === 0) && noteNames.length > 4) {
          detectedChords = Tonal.Chord.detect(noteNames.slice(0, 4));
      }

      // Paso C: Sanitizaci√≥n y Display
      if (detectedChords && detectedChords.length > 0) {
        let chordName = detectedChords[0];
        // Eliminar "M" final redundante de mayores
        if (/^[A-G](?:#|b)?M$/.test(chordName)) chordName = chordName.replace("M", "");
        chordDisplay.textContent = chordName;
      } else {
        // Mostrar "??" si no se detecta nada
        chordDisplay.innerHTML = '<span class="chord-placeholder" style="font-size:20px">??</span>';
      }

      try {
        drawGrandStaff(notesArray);
      } catch (err) {
        console.error("VexFlow Err:", err);
      }
    }

    function drawEmptyStaff() {
      staffContainer.innerHTML = "";
      const renderer = new Vex.Flow.Renderer(staffContainer, Vex.Flow.Renderer.Backends.SVG);
      renderer.resize(400, 450);
      const context = renderer.getContext();
      
      const staveTreble = new Vex.Flow.Stave(10, 100, 300);
      staveTreble.addClef("treble").setContext(context).draw();
      
      const staveBass = new Vex.Flow.Stave(10, 250, 300);
      staveBass.addClef("bass").setContext(context).draw();

      new Vex.Flow.StaveConnector(staveTreble, staveBass).setType(3).setContext(context).draw();
      new Vex.Flow.StaveConnector(staveTreble, staveBass).setType(1).setContext(context).draw();
      new Vex.Flow.StaveConnector(staveTreble, staveBass).setType(6).setContext(context).draw();
    }
    
    drawEmptyStaff();

    function drawGrandStaff(midiNotes) {
      staffContainer.innerHTML = "";
      const renderer = new Vex.Flow.Renderer(staffContainer, Vex.Flow.Renderer.Backends.SVG);
      const width = 400;
      renderer.resize(width, 450);
      const context = renderer.getContext();

      const trebleNotes = [];
      const bassNotes = [];

      midiNotes.forEach(midi => {
        const tonalNote = getMidiNameSharp(midi);
        const noteInfo = Tonal.Note.get(tonalNote); 
        const letter = tonalNote.slice(0, -1).toLowerCase();
        const octave = tonalNote.slice(-1);
        const vfKey = `${letter}/${octave}`;

        const staveNote = new Vex.Flow.StaveNote({ 
          clef: midi >= 60 ? "treble" : "bass", 
          keys: [vfKey], 
          duration: "w", 
          align_center: true 
        });

        if (noteInfo.acc === '#') staveNote.addModifier(new Vex.Flow.Accidental("#"));
        else if (noteInfo.acc === 'b') staveNote.addModifier(new Vex.Flow.Accidental("b"));

        if (midi >= 60) trebleNotes.push(staveNote);
        else bassNotes.push(staveNote);
      });

      const staveTreble = new Vex.Flow.Stave(10, 100, width - 20);
      staveTreble.addClef("treble").setContext(context).draw();

      const staveBass = new Vex.Flow.Stave(10, 250, width - 20);
      staveBass.addClef("bass").setContext(context).draw();

      new Vex.Flow.StaveConnector(staveTreble, staveBass).setType(3).setContext(context).draw(); 
      new Vex.Flow.StaveConnector(staveTreble, staveBass).setType(1).setContext(context).draw(); 
      new Vex.Flow.StaveConnector(staveTreble, staveBass).setType(6).setContext(context).draw(); 

      if (trebleNotes.length > 0) {
        const trebleMidiVals = midiNotes.filter(n => n >= 60);
        const keysTreble = trebleMidiVals.map(n => {
             const tn = getMidiNameSharp(n);
             return `${tn.slice(0, -1).toLowerCase()}/${tn.slice(-1)}`;
        });

        if (keysTreble.length > 0) {
            const chordTreble = new Vex.Flow.StaveNote({ clef: "treble", keys: keysTreble, duration: "w" });
            trebleMidiVals.forEach((m, index) => {
                const info = Tonal.Note.get(getMidiNameSharp(m));
                if (info.acc === "#") chordTreble.addModifier(new Vex.Flow.Accidental("#"), index);
                if (info.acc === "b") chordTreble.addModifier(new Vex.Flow.Accidental("b"), index);
            });
            const voiceT = new Vex.Flow.Voice({num_beats: 4, beat_value: 4});
            voiceT.addTickables([chordTreble]);
            new Vex.Flow.Formatter().joinVoices([voiceT]).format([voiceT], width - 50);
            voiceT.draw(context, staveTreble);
        }
      }

      if (bassNotes.length > 0) {
         const bassMidiVals = midiNotes.filter(n => n < 60);
         const keysBass = bassMidiVals.map(n => {
             const tn = getMidiNameSharp(n);
             return `${tn.slice(0, -1).toLowerCase()}/${tn.slice(-1)}`;
        });

        if (keysBass.length > 0) {
            const chordBass = new Vex.Flow.StaveNote({ clef: "bass", keys: keysBass, duration: "w" });
            bassMidiVals.forEach((m, index) => {
                const info = Tonal.Note.get(getMidiNameSharp(m));
                if (info.acc === "#") chordBass.addModifier(new Vex.Flow.Accidental("#"), index);
                if (info.acc === "b") chordBass.addModifier(new Vex.Flow.Accidental("b"), index);
            });
            const voiceB = new Vex.Flow.Voice({num_beats: 4, beat_value: 4});
            voiceB.addTickables([chordBass]);
            new Vex.Flow.Formatter().joinVoices([voiceB]).format([voiceB], width - 50);
            voiceB.draw(context, staveBass);
        }
      }
    }
  </script>
</body>
</html>