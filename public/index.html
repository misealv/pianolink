<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Piano Link ‚Äì Conexi√≥n MIDI remota</title>
    <style>
      :root {
        --bg-main: #f6f8fc;
        --primary: #4a90e2;        /* azul claro principal */
        --primary-dark: #2f5fad;   /* azul un poco m√°s intenso */
        --accent: #ffc107;
        --text-main: #222222;
        --text-muted: #606f89;
        --card-bg: #ffffff;

        --teacher-rgb: 74, 144, 226;  /* Azul profesor */
        --student-rgb: 255, 193, 7;   /* Amarillo alumno */
      }

      * { box-sizing: border-box; }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        max-width: 960px;
        margin: 0 auto;
        padding: 20px 16px 40px;
        background: var(--bg-main);
        color: var(--text-main);
      }

      a { color: var(--primary-dark); text-decoration: none; }

      /* Header azul claro */
      .hero {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #0d305a;
        border-radius: 14px;
        padding: 18px 20px;
        margin-bottom: 20px;
        box-shadow: 0 3px 8px rgba(15, 35, 80, 0.15);
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }
      .hero-left { max-width: 520px; }
      .hero-title {
        margin: 0 0 4px;
        font-size: 30px;
        font-weight: 800;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
      .hero-subtitle {
        margin: 0 0 6px;
        font-size: 14px;
        color: #1e3a5f;
      }
      .hero-tagline {
        margin: 0 0 10px;
        font-size: 12px;
        color: #35527a;
      }
      .hero-badge {
        display: inline-block;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(13, 48, 90, 0.2);
      }
      .hero-right {
        text-align: right;
        min-width: 160px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      .hero-project {
        font-size: 12px;
        margin-bottom: 2px;
        opacity: 0.9;
      }

      .panic-btn {
        background: #d32f2f;
        color: white;
        border: 1px solid #b71c1c;
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: background 0.2s;
      }
      .panic-btn:hover { background: #b71c1c !important; }

      /* Status */
      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 99px;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-align: center;
      }
      .status-connected {
        background-color: #e8f5e9;
        color: #1b5e20;
        border: 1px solid #a5d6a7;
      }
      .status-disconnected {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
        animation: pulse-red 2s infinite;
      }
      .status-connecting {
        background-color: #fffde7;
        color: #f9a825;
        border: 1px solid #fff59d;
      }
      @keyframes pulse-red {
        0%   { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); }
        70%  { box-shadow: 0 0 0 6px rgba(229, 57, 53, 0.0); }
        100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.0); }
      }

      /* Cards */
      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: 0 2px 6px rgba(15, 35, 80, 0.06);
        margin-bottom: 16px;
        border: 1px solid #dde3f0;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .section-title {
        margin: 0;
        font-size: 15px;
        color: var(--primary-dark);
        font-weight: 600;
      }
      .section { margin-bottom: 10px; }

      .role-help {
        font-size: 13px;
        background: #edf3ff;
        border-left: 3px solid var(--primary);
        padding: 8px;
        margin-top: 6px;
        border-radius: 4px;
        color: #1b3559;
      }
      .inline-help {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .log {
        border: 1px solid #d0d8ea;
        height: 150px;
        padding: 8px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-size: 12px;
        background: #f8faff;
        border-radius: 4px;
      }
      .note-box {
        border: 1px solid #d0d8ea;
        padding: 6px;
        font-size: 14px;
        background: #ffffff;
        border-radius: 4px;
      }
      .hidden { display: none; }

      /* EN VIVO badge (panel del estudiante) */
      .live-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 10px;
        padding: 6px 12px;
        border-radius: 999px;
        background: #e8f5e9;
        color: #1b5e20;
        border: 1px solid #a5d6a7;
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
      }
      .live-badge-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #2ecc71;
        box-shadow: 0 0 8px rgba(46, 204, 113, 0.9);
      }
      .live-badge.hidden { display: none; }

      /* Controles */
      button {
        background: var(--primary);
        color: #ffffff;
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 13px;
        cursor: pointer;
      }
      button:disabled {
        background: #c0c8d8;
        cursor: default;
      }
      button:hover:not(:disabled) { background: var(--primary-dark); }

      input[type="text"],
      #codigoSala,
      #inviteLink {
        padding: 5px 7px;
        border-radius: 4px;
        border: 1px solid #c5cad8;
        font-size: 13px;
        min-width: 120px;
      }
      #inviteLink { width: 100%; }
      select {
        padding: 5px 7px;
        border-radius: 4px;
        border: 1px solid #c5cad8;
        font-size: 13px;
      }

      /* Piano 88 teclas + pedal */
      .piano-wrapper {
        border: 1px solid #c0c4d0;
        overflow-x: auto;
        overflow-y: hidden;
        height: 180px;
        background: #e3e7f3;
        border-radius: 6px;
      }
      .piano { position: relative; height: 100%; }

      .key {
        position: absolute;
        box-sizing: border-box;
        transition: transform 0.05s ease, background-color 0.05s ease;
      }
      .white-key {
        height: 100%;
        background: #ffffff;
        border: 1px solid #000;
        bottom: 0;
        z-index: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
      }
      .black-key {
        height: 55%;
        background: #000000;
        border: 1px solid #000;
        top: 0;
        z-index: 5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
      }
      .note-label {
        position: absolute;
        bottom: 2px;
        left: 2px;
        font-size: 8px;
        color: #333;
        pointer-events: none;
      }

      .white-key.active-teacher,
      .white-key.active-student {
        transform: translateY(4px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .black-key.active-teacher,
      .black-key.active-student {
        transform: translateY(3px);
        box-shadow: inset 0 2px 3px rgba(255, 255, 255, 0.25);
      }

      /* Indicador de pedal asociado al piano */
      .pedal-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }
      .pedal-indicator {
        font-size: 11px;
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 999px;
        background: #eef0f5;
        color: #455a64;
        border: 1px solid #cfd8dc;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .pedal-indicator-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #9e9e9e;
      }
      .pedal-indicator.active {
        background: #4caf50;
        color: #ffffff;
        border-color: #388e3c;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
      }
      .pedal-indicator.active .pedal-indicator-dot {
        background: #c8e6c9;
      }

      .layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
        gap: 16px;
      }
      @media (max-width: 768px) {
        .layout-grid { grid-template-columns: 1fr; }
        .hero, .hero-right {
          text-align: left;
          align-items: flex-start;
        }
      }

      .footer {
        margin-top: 18px;
        font-size: 11px;
        text-align: center;
        color: #8892a6;
      }
    </style>
  </head>

  <body>
    <header class="hero">
      <div class="hero-left">
        <h1 class="hero-title">Piano Link</h1>
        <p class="hero-subtitle">
          Sistema web para conectar pianos digitales v√≠a MIDI y realizar clases en tiempo real.
        </p>
        <p class="hero-tagline">
          <span style="color:#f9a825; font-weight:600;">‚ñ† Alumno (Amarillo)</span> ¬∑
          <span style="color:#1565c0; font-weight:600;">‚ñ† Profesor (Azul)</span>
        </p>
        <span class="hero-badge">Proyecto de Miguel Antonio</span>
      </div>
      <div class="hero-right">
        <div id="connectionStatus" class="status-badge status-connecting">Conectando...</div>
        <button id="panicBtn" class="panic-btn">üîá Reset / P√°nico</button>
      </div>
    </header>

    <div class="card" id="roleCard">
      <h2 class="section-title">1. Configuraci√≥n de entrada</h2>
      <div class="section">
        <label id="teacherRoleOption">
          <input type="radio" name="rol" value="teacher" checked /> Profesor
        </label>
        &nbsp;&nbsp;
        <label id="studentRoleOption">
          <input type="radio" name="rol" value="student" /> Alumno
        </label>
      </div>
      <div style="margin-top:10px; margin-bottom:10px;">
        <input
          type="text"
          id="inputName"
          placeholder="Tu nombre (ej: Miguel)"
          style="width:100%; font-weight:bold;"
        />
      </div>
      <div id="roleHelp" class="role-help"></div>

      <!-- EN VIVO: panel del estudiante -->
      <div id="liveBadge" class="live-badge hidden">
        <span class="live-badge-dot"></span>
        <span>EN VIVO</span>
      </div>
    </div>

    <div class="card" id="roomCard">
      <h2 class="section-title">2. Conectarse a la misma sala</h2>
      <div class="section">
        <button id="crearSala">Crear sala</button>
        <input id="codigoSala" placeholder="C√≥digo de sala" />
        <button id="unirseSala">Unirse</button>
        <div class="inline-help">
          El profesor crea la sala. El alumno se une con el c√≥digo.
        </div>
      </div>
      <div class="section" id="inviteSection">
        <h3 class="section-title">Link de invitaci√≥n</h3>
        <div style="margin-top:6px;">
          <input id="inviteLink" readonly placeholder="Crea una sala primero..." />
        </div>
        <div style="margin-top:6px;">
          <button id="copyInviteBtn">Copiar link</button>
        </div>
        <div id="copyStatus" class="inline-help"></div>
      </div>
    </div>

    <div class="layout-grid">
      <div>
        <div class="card" id="noteCard">
          <h2 class="section-title">3. Nota actual</h2>
          <div class="note-box" id="noteDisplay">‚Äî</div>
        </div>

        <div class="card" id="pianoCard">
          <div class="section-header">
            <h2 class="section-title">Piano visual (88 teclas)</h2>
          </div>
          <div class="piano-wrapper">
            <div id="piano" class="piano"></div>
          </div>
          <div class="pedal-container">
            <div id="sustainPedal" class="pedal-indicator">
              <span class="pedal-indicator-dot"></span>
              <span>Pedal Sustain</span>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" id="advancedCard">
          <h2 class="section-title">Opciones</h2>
          <div class="section">
            <label>
              Salida MIDI:
              <select id="midiOutputSelect">
                <option value="">(ninguna)</option>
              </select>
            </label>
          </div>
          <div class="section">
            <label>
              <input type="checkbox" id="toggleMidiOut" />
              Activar salida MIDI a mi teclado
            </label>
          </div>
        </div>

        <div class="card" id="logCard">
          <h2 class="section-title">Log</h2>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>

    <div class="footer">Piano Link ¬∑ Conexi√≥n MIDI remota</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      // Referencias DOM
      const inputName = document.getElementById("inputName");
      const crearSala = document.getElementById("crearSala");
      const unirseSala = document.getElementById("unirseSala");
      const codigoSala = document.getElementById("codigoSala");
      const logDiv = document.getElementById("log");
      const toggleMidiOut = document.getElementById("toggleMidiOut");
      const midiOutputSelect = document.getElementById("midiOutputSelect");
      const piano = document.getElementById("piano");
      const roleHelp = document.getElementById("roleHelp");
      const noteDisplay = document.getElementById("noteDisplay");
      const advancedCard = document.getElementById("advancedCard");
      const inviteLinkInput = document.getElementById("inviteLink");
      const copyInviteBtn = document.getElementById("copyInviteBtn");
      const copyStatus = document.getElementById("copyStatus");
      const inviteSection = document.getElementById("inviteSection");
      const statusEl = document.getElementById("connectionStatus");
      const sustainPedalEl = document.getElementById("sustainPedal");
      const panicBtn = document.getElementById("panicBtn");
      const liveBadge = document.getElementById("liveBadge");

      const teacherRadio = document.querySelector('input[name="rol"][value="teacher"]');
      const studentRadio = document.querySelector('input[name="rol"][value="student"]');
      const teacherRoleOption = document.getElementById("teacherRoleOption");

      // Estado Global
      let rol = "teacher";
      let salaActual = null;
      let myName = "";
      let lockStudentFromLink = false; // si entra por link como alumno, no puede cambiar a profesor

      let midiAccessGlobal = null;
      let midiOutput = null;
      let midiOutputs = [];
      let enableMidiOut = false;
      const keyElementsByNote = {};

      // ===========================
      // 1. L√ìGICA DE SALAS
      // ===========================

      crearSala.addEventListener("click", () => {
        const name = inputName.value.trim();
        if (!name) return alert("Por favor ingresa tu nombre primero.");

        myName = name;
        rol = "teacher";
        if (teacherRadio) teacherRadio.checked = true;

        socket.emit("create-room", { username: name });
        log("‚è≥ Solicitando nueva sala como Profesor...");
      });

      socket.on("room-created", (code) => {
        salaActual = code;
        codigoSala.value = code; // el c√≥digo aparece en "unirse a la sala"
        log("‚úÖ Sala creada con √©xito: " + code);
        updateInviteLink();
      });

      unirseSala.addEventListener("click", () => {
        const code = codigoSala.value.trim().toUpperCase();
        const name = inputName.value.trim();

        if (!name) return alert("Ingresa tu nombre.");
        if (!code) return alert("Ingresa el c√≥digo de la sala.");

        myName = name;
        salaActual = code;
        socket.emit("join-room", code);
        log("‚è≥ Uni√©ndose a sala " + code + " como " + rol + "...");
        updateInviteLink();
      });

      // ===========================
      // 2. ESTADO Y LINKS
      // ===========================

      function updateStatus(state) {
        statusEl.className = "status-badge";
        if (state === "connected") {
          statusEl.classList.add("status-connected");
          statusEl.textContent = "üü¢ Conectado";
        } else if (state === "disconnected") {
          statusEl.classList.add("status-disconnected");
          statusEl.textContent = "üî¥ Desconectado";
        } else {
          statusEl.classList.add("status-connecting");
          statusEl.textContent = "üü° Conectando...";
        }
      }

      socket.on("connect", () => {
        updateStatus("connected");
        if (salaActual) socket.emit("join-room", salaActual);
      });
      socket.on("disconnect", () => updateStatus("disconnected"));
      socket.on("connect_error", () => updateStatus("disconnected"));

      setInterval(() => {
        if (socket.connected) socket.emit("ping_keep_alive");
      }, 25000);

      function updateInviteLink() {
        if (rol !== "teacher" || !salaActual) {
          inviteLinkInput.value = "";
          return;
        }
        const url = new URL(window.location.href);
        url.searchParams.set("role", "student");
        url.searchParams.set("room", salaActual);
        inviteLinkInput.value = url.toString();
      }

      copyInviteBtn.addEventListener("click", async () => {
        const value = inviteLinkInput.value.trim();
        if (!value) {
          copyStatus.style.color = "#c62828";
          copyStatus.textContent = "Crea una sala primero para generar el link.";
          setTimeout(() => (copyStatus.textContent = ""), 2500);
          return;
        }
        try {
          await navigator.clipboard.writeText(value);
          copyStatus.style.color = "#1b5e20";
          copyStatus.textContent = "Link copiado al portapapeles.";
        } catch {
          copyStatus.style.color = "#c62828";
          copyStatus.textContent =
            "No se pudo copiar autom√°ticamente. Copia el texto a mano.";
        }
        setTimeout(() => (copyStatus.textContent = ""), 2500);
      });

      // ===========================
      // 3. UI, ROLES Y EN VIVO
      // ===========================

      function updateRoleUI() {
        if (rol === "teacher") {
          roleHelp.textContent =
            "Modo Profesor: ves tus notas en AZUL, tus alumnos en AMARILLO.";
          advancedCard.classList.remove("hidden");
          inviteSection.classList.remove("hidden");
          setStudentLive(false);
        } else {
          roleHelp.textContent =
            "Modo Alumno: el profesor ve tus notas en AMARILLO.";
          advancedCard.classList.remove("hidden");
          inviteSection.classList.add("hidden");
          // Por defecto, el alumno no est√° EN VIVO hasta que lo defina el sistema
          // (funci√≥n lista para conectarse a evento del servidor)
        }
      }

      document.querySelectorAll('input[name="rol"]').forEach((r) => {
        r.addEventListener("change", (e) => {
          if (lockStudentFromLink && e.target.value === "teacher") {
            // Si vino por link de alumno, bloquear cambio a profesor
            if (studentRadio) studentRadio.checked = true;
            rol = "student";
            updateRoleUI();
            return;
          }
          rol = e.target.value;
          updateRoleUI();
          updateInviteLink();
        });
      });

      function setStudentLive(isLive) {
        if (!liveBadge) return;
        if (rol !== "student") {
          liveBadge.classList.add("hidden");
          return;
        }
        if (isLive) liveBadge.classList.remove("hidden");
        else liveBadge.classList.add("hidden");
      }

      // Ejemplo de c√≥mo se conectar√≠a al servidor:
      // socket.on("live-student-changed", ({ socketId }) => {
      //   const isMe = (socket.id === socketId);
      //   setStudentLive(isMe);
      // });

      // Inicializar desde URL (cuando alumno entra por link)
      (function initFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const urlRole = params.get("role");
        const urlRoom = params.get("room") || params.get("sala");

        if (urlRole === "student") {
          rol = "student";
          if (studentRadio) studentRadio.checked = true;
          lockStudentFromLink = true;

          // Esconder opci√≥n de profesor si viene por link de alumno
          if (teacherRoleOption) {
            teacherRoleOption.style.display = "none";
          }
          if (teacherRadio) {
            teacherRadio.disabled = true;
          }
        }

        if (urlRoom) {
          codigoSala.value = urlRoom; // rellena "unirse a la sala"
          salaActual = urlRoom;
        }

        updateRoleUI();
      })();

      // ===========================
      // 4. MIDI ENGINE
      // ===========================

      function log(msg) {
        logDiv.textContent += msg + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(
          onMIDISuccess,
          () => log("‚ùå Sin soporte MIDI")
        );
      } else {
        log("‚ö†Ô∏è Navegador no soporta Web MIDI");
      }

      function onMIDISuccess(midi) {
        midiAccessGlobal = midi;
        log("‚úÖ MIDI activo");
        for (let input of midi.inputs.values()) {
          input.onmidimessage = handleMIDIMessageFromDevice;
        }
        midiOutputs = Array.from(midi.outputs.values());
        midiOutputSelect.innerHTML = '<option value="">(ninguna)</option>';
        midiOutputs.forEach((out, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = out.name;
          midiOutputSelect.appendChild(opt);
        });
      }

      toggleMidiOut.addEventListener("change", (e) => {
        enableMidiOut = e.target.checked;
        log("Salida MIDI: " + (enableMidiOut ? "ON" : "OFF"));
      });

      midiOutputSelect.addEventListener("change", (e) => {
        const idx = e.target.value;
        midiOutput =
          idx !== "" && midiOutputs[idx] ? midiOutputs[idx] : null;
      });

      function handleMIDIMessageFromDevice(event) {
        const [status, data1, data2] = event.data;
        const command = status & 0xf0;

        // Visual local
        handleRemoteOrLocalNote({
          type: "raw_midi",
          command,
          note: data1,
          velocity: data2,
          fromRole: rol,
        });

        if (!salaActual) return;

        if (command === 0x90 || command === 0x80) {
          const targetChannel = rol === "teacher" ? 1 : 0;
          const outStatus = (command | targetChannel) & 0xff;
          socket.emit("midi-message", {
            roomCode: salaActual,
            message: {
              type: "note",
              command: outStatus,
              note: data1,
              velocity: data2,
              fromRole: rol,
            },
          });
        } else if (command === 0xb0) {
          socket.emit("midi-message", {
            roomCode: salaActual,
            message: {
              type: "cc",
              status,
              controller: data1,
              value: data2,
              fromRole: rol,
            },
          });
        }
      }

      socket.on("midi-message", (msg) => handleRemoteOrLocalNote(msg));

      function handleRemoteOrLocalNote(msg) {
        let cmd, note, velocity, role, type;

        if (msg.type === "raw_midi") {
          cmd = msg.command;
          note = msg.note;
          velocity = msg.velocity;
          role = msg.fromRole;
          type = "raw";
        } else if (msg.type === "note") {
          cmd = msg.command & 0xf0;
          note = msg.note;
          velocity = msg.velocity;
          role = msg.fromRole;
          type = "remote";
        } else {
          handleOtherMessages(msg);
          return;
        }

        const isNoteOn = cmd === 0x90 && velocity > 0;

        // Piano visual
        const keyEl = keyElementsByNote[note];
        if (keyEl) {
          const activeClass =
            role === "teacher" ? "active-teacher" : "active-student";
          if (isNoteOn) {
            const alpha = 0.3 + (velocity / 127) * 0.7;
            const baseRGB =
              role === "teacher"
                ? "var(--teacher-rgb)"
                : "var(--student-rgb)";
            keyEl.classList.add(activeClass);
            keyEl.style.backgroundColor = `rgba(${baseRGB}, ${alpha})`;
          } else {
            keyEl.classList.remove("active-teacher", "active-student");
            keyEl.style.backgroundColor = "";
          }
        }

        if (isNoteOn && type !== "raw") {
          noteDisplay.textContent = `${
            role === "teacher" ? "PROFE" : "ALUMNO"
          }: ${noteNumberToName(note)}`;
        }

        // Salida MIDI (qui√©n escucha a qui√©n)
        if (type !== "raw") {
          const soyProfe = rol === "teacher";
          const vieneDeProfe = role === "teacher";
          const deboReproducir =
            enableMidiOut &&
            midiOutput &&
            ((soyProfe && !vieneDeProfe) ||
              (!soyProfe && vieneDeProfe));

          if (deboReproducir) {
            try {
              midiOutput.send([
                isNoteOn ? 0x90 : 0x80,
                note,
                velocity,
              ]);
            } catch (e) {}
          }
        }
      }

      function handleOtherMessages(msg) {
        if (msg.type === "raw_midi") {
          if ((msg.command & 0xf0) === 0xb0 && msg.note === 64)
            updatePedalVisual(msg.velocity);
          return;
        }

        if (msg.type === "cc" && msg.controller === 64) {
          updatePedalVisual(msg.value);
        }

        const soyProfe = rol === "teacher";
        const vieneDeProfe = msg.fromRole === "teacher";
        const deboReproducir =
          enableMidiOut &&
          midiOutput &&
          ((soyProfe && !vieneDeProfe) ||
            (!soyProfe && vieneDeProfe));

        if (deboReproducir && msg.type === "cc") {
          midiOutput.send([msg.status, msg.controller, msg.value]);
        }
      }

      function updatePedalVisual(value) {
        if (!sustainPedalEl) return;
        sustainPedalEl.classList.toggle("active", value >= 64);
      }

      function noteNumberToName(note) {
        const names = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];
        return names[note % 12] + (Math.floor(note / 12) - 1);
      }

      // Piano 88 teclas
      (function buildPiano() {
        const WHITE_KEYS = [0, 2, 4, 5, 7, 9, 11];
        const pianoDiv = document.getElementById("piano");
        const WHITE_WIDTH = 26;
        const BLACK_WIDTH = 16;

        pianoDiv.style.width = 52 * WHITE_WIDTH + "px";
        let wIdx = 0;

        for (let i = 21; i <= 108; i++) {
          const isWhite = WHITE_KEYS.includes(i % 12);
          const k = document.createElement("div");
          k.className = "key " + (isWhite ? "white-key" : "black-key");
          k.dataset.note = i;

          if (isWhite) {
            k.style.left = wIdx * WHITE_WIDTH + "px";
            k.style.width = WHITE_WIDTH + "px";
            if (i % 12 === 0) {
              k.innerHTML =
                '<div class="note-label">' +
                noteNumberToName(i) +
                "</div>";
            }
            wIdx++;
          } else {
            k.style.left =
              (wIdx - 0.5) * WHITE_WIDTH - BLACK_WIDTH / 2 + "px";
            k.style.width = BLACK_WIDTH + "px";
          }

          pianoDiv.appendChild(k);
          keyElementsByNote[i] = k;
        }
      })();

      // Bot√≥n de p√°nico
      panicBtn.addEventListener("click", () => {
        log("üîá P√°nico presionado");
        document.querySelectorAll(".key").forEach((k) => {
          k.classList.remove("active-teacher", "active-student");
          k.style.backgroundColor = "";
        });
        updatePedalVisual(0);
        if (midiOutput) {
          for (let c = 0; c < 16; c++) {
            midiOutput.send([0xb0 | c, 123, 0]);
          }
        }
      });
    </script>
  </body>
</html>
