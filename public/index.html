<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Piano Link | Masterclass Studio Pro</title>

  <script src="/guard.js"></script>
  <link rel="stylesheet" href="/css/style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

  <style>
    /* Estilos del Visor PDF (Atril) */
    .pdf-viewer-container {
        width: 100%; height: calc(100% - 50px); overflow: auto;
        background-color: #525659; display: flex; flex-direction: column; align-items: center; position: relative;
    }
    canvas#pdf-render { 
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
    display: block; /* Elimina espacios fantasma */
    }   

/* Aplica el margen al wrapper para que AMBOS canvas se muevan juntos */
    #score-wrapper {
    margin: 20px 0;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); /* Sombra al conjunto */
}

 .pdf-controls-floating {
        position: sticky; bottom: 20px; background: rgba(0, 0, 0, 0.8);
        padding: 8px 15px; border-radius: 20px; display: flex; gap: 10px; align-items: center; z-index: 10; color: white; font-size: 12px;
    }
    .library-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
    .library-content { background-color: #1e1e1e; color: #eee; margin: 5% auto; padding: 20px; border: 1px solid #444; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .shelf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
    .score-card { background: #2a2a2a; border: 1px solid #444; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
    .score-card:hover { background: #3a3a3a; border-color: var(--accent, #ff764d); transform: translateY(-2px); }
    .score-icon { font-size: 30px; margin-bottom: 5px; }
    .score-title { font-weight: bold; font-size: 0.85rem; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
    .score-meta { font-size: 0.7rem; color: #aaa; }
    .upload-area { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 8px; background: #252525; margin-bottom: 20px; }

    /* Estilos para el bot√≥n de estado */
    .status-indicator {
          font-size: 11px; padding: 6px 12px; background: #333; border-radius: 20px;
          border: 1px solid #444; transition: all 0.3s ease; font-weight: bold;
          display: flex; align-items: center; gap: 6px;
      }
      .status-indicator.connected {
          background: #2ecc71; color: #000; border-color: #27ae60;
          box-shadow: 0 0 10px rgba(46, 204, 113, 0.4);
      }
  </style>
</head>

<body>
  <audio id="joinSound" src="https://cdn.freesound.org/previews/352/352651_4019029-lq.mp3"></audio>
  
  <div class="app-container">
    <header class="header" style="justify-content: space-between; align-items: center; padding: 0 20px;">
      
      <div class="brand" style="display: flex; align-items: center; gap: 10px;">
        <div id="headerLogo">üéπ</div>
        <div style="display: flex; flex-direction: column; line-height: 1.2;">
            <span id="headerTitle" style="font-weight: 700; font-size: 15px; color: #fff;">PIANO LINK</span>
            <span id="headerSubtitle" style="font-size: 10px; color: var(--accent); letter-spacing: 1px;">STUDIO PRO</span>
        </div>
      </div>

      <div id="systemBrand" style="display: flex; align-items: center; gap: 8px; opacity: 0.6; transform: scale(0.9);"></div>

      <div id="status" class="status-indicator">üî¥ Conectando...</div>
    </header>

    <aside class="sidebar">
      <div class="panel">
        <h2>Identidad</h2>
        <div class="config-row">
          <input type="text" id="inputName" placeholder="Escribe tu Nombre..." style="color: #fff; cursor: text;" />
        </div>
        <div id="roleIndicator" class="badge" style="background:var(--prof-color); color:#000; text-align:center; margin-top:4px;">Cargando rol...</div>
        <div style="display:none;">
            <input type="radio" name="rol" value="teacher" id="radioTeacher">
            <input type="radio" name="rol" value="student" id="radioStudent">
        </div>
      </div>

      <div class="panel">
        <h2>Sesi√≥n</h2>
        <div id="cardCrearSala">
          <button id="btnMagicLink" class="primary" style="width:100%; font-weight:800; padding:15px; margin-bottom:5px;">üöÄ COMENZAR CLASE</button>
          <div id="magicFeedback" style="font-size: 10px; color: #b4e080; text-align: center; min-height: 15px;"></div>
          <button id="btnEndClass" class="danger" style="width:100%; margin-top:15px; font-size:11px; display:none;">üõë TERMINAR CLASE</button>
        </div>
        <div id="cardUnirseSala" style="display:none;">
          <div id="joinControls" style="display:flex; gap:4px;">
            <input type="text" id="codigoSala" maxlength="20" placeholder="C√ìDIGO" style="text-transform:uppercase; text-align:center;">
            <button id="btnUnirse" class="primary">Unirse</button>
          </div>
          <button id="btnExitClass" class="btn-outline" style="width:100%; border-color:var(--danger); color:var(--danger); margin-top:10px; display:none;">üö™ SALIR DE LA CLASE</button>
        </div>
      </div>

      <div class="panel">
        <h2>MIDI I/O</h2>
        <div class="config-row"><label>Entrada (Teclado):</label><select id="midiInputSelect" style="width:100%"><option value="">(Cargando MIDI...)</option></select></div>
        <div class="config-row"><label>Salida (Sonido):</label><select id="midiOutputSelect" style="width:100%"><option value="">(ninguna)</option></select></div>
        <label><input type="checkbox" id="toggleMidiOut"> Enviar a mi sintetizador</label>
      </div>

      <div class="panel" id="participantsCard">
        <h2>Participantes</h2>
        <div id="participantsList" class="participants-list"><div style="color:var(--text-muted); font-size:10px;">Esperando conexiones...</div></div>
      </div>

      <div id="masterclassSection" class="panel hidden" style="border-color: var(--danger);">        
        <h2 style="color:var(--danger)">üì° Masterclass / Broadcast</h2>
        <div class="config-row">
          <label style="cursor:pointer; display:flex; align-items:center; gap:8px;"><input type="checkbox" id="masterclassToggle"> <strong>Habilitar Modo "En el Aire"</strong></label>
        </div>
        <p style="font-size:10px; color:var(--text-muted); margin-bottom:8px;">Selecciona "ON AIR" en un alumno para retransmitir su piano a todos.</p>
        <button id="clearLiveBtn" class="danger" style="width:100%; font-size:10px;">‚èπ DETENER TRANSMISI√ìN</button>
      </div>

      <div class="panel" style="flex:1; display:flex; flex-direction:column; min-height:100px;">
        <h2>System Log</h2>
        <div id="log" class="log-terminal"></div>
      </div>
    </aside>

    <main class="main-stage" style="position:relative;">
      <div id="waitingRoomOverlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:100; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center;">
        <div style="font-size:50px; margin-bottom:20px;">‚òï</div>
        <h2 style="color:var(--accent);">SALA DE ESPERA</h2>
        <p id="waitingText">Tu piano se activar√° cuando el profesor inicie la clase.</p>
      </div>
      
      <div class="board-tabs">
        <button id="tabMusicBtn" class="tab-btn active">üéπ ACORDES</button>
        <button id="tabPdfBtn" class="tab-btn">üìö BIBLIOTECA PDF</button> 
      </div>

      <div class="board-container">
        <div id="modeMusic" class="board-mode">
            <div id="staffContainer"></div>
            <div id="chordDisplay"><span class="chord-placeholder">--</span></div>
        </div>
        <div id="modePdf" class="board-mode hidden" style="display:none; flex-direction:column; height:100%;">
            <div class="pdf-controls" style="display: flex; align-items: center; justify-content:space-between; padding: 10px; background-color: #333; border-bottom: 2px solid #555; height: 50px; flex-shrink: 0;">
                <div style="display:flex; align-items:center; gap:10px; width:100%;">
                    <button id="btnOpenShelf" class="primary" style="padding: 0 15px; height: 30px; cursor: pointer; white-space:nowrap;">üìÇ ABRIR ESTANTE</button>
                    <span id="current-score-title" style="font-size:12px; color:#aaa; font-style:italic; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Sin partitura seleccionada</span>
                </div>
            </div>
            <div id="pdf-container" class="pdf-viewer-container">
              <div id="pdf-loading-msg" style="margin-top:50px; color:#777; display:none;">Cargando partitura...</div>
              <div id="drawing-toolbar" class="drawing-toolbar" style="display:none;">
                <button id="tool-move" class="tool-btn active" title="Modo Navegaci√≥n (Mover)">‚úã</button>
                
                <button id="tool-pencil" class="tool-btn" title="Modo Dibujo">‚úèÔ∏è</button>
                <div class="tool-separator"></div>
               <button id="tool-laser" class="tool-btn" title="Puntero L√°ser">üî¥</button>
                <div class="tool-separator"></div>
                <input type="color" id="tool-color" value="#ff0000" title="Color del L√°piz">
                
                <div class="tool-separator"></div>
                <button id="tool-clear" class="tool-btn btn-danger" title="Borrar Pizarra">üóëÔ∏è</button>
            </div>
              <div id="score-wrapper" style="position: relative; display: inline-block;">
                  <canvas id="pdf-render" style="display: block;"></canvas>
                  <canvas id="annotation-layer"></canvas> </div>
                  <canvas id="pdf-render" style="display: block;"></canvas>
                  <canvas id="annotation-layer"></canvas>
        
             <div id="remote-laser" class="laser-dot"></div>
              <div class="pdf-controls-floating" id="pdfFloatingControls" style="display:none;">
                  <button id="zoom-out" class="btn-sm" title="Zoom -">üîç-</button>
                  <button id="zoom-in" class="btn-sm" title="Zoom +">üîç+</button>
                  <span style="margin: 0 5px; color:#555;">|</span>
                  <button id="prev-page" class="btn-sm">‚ùÆ</button>
                  <span>P√°g <span id="page-num">0</span> / <span id="page-count">0</span></span>
                  <button id="next-page" class="btn-sm">‚ùØ</button>
              </div>
          </div>
        </div>
        <div id="resizeHandle" class="resize-handle" title="Arrastra para redimensionar"><span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
      </div> 
      
      <div class="piano-container">
        <div class="piano-toolbar">
            <div class="toolbar-group">
                <label for="baseColorPicker" style="font-size:10px; margin-right:5px;">Base:</label>
                <input type="color" id="baseColorPicker" value="#ff764d" style="border:none; width:20px; height:20px; padding:0;"> 
            </div>
            <div class="toolbar-group">
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size:11px;">
                    <input type="checkbox" id="chkSplit"> <strong>Split</strong>
                </label>
            </div>
            <div id="splitControls" class="toolbar-group hidden" style="display:flex; align-items:center; gap:10px;">
                <div style="display:flex; align-items:center; gap:3px;"><label style="font-size:9px; color:#aaa;">NOTA:</label><input type="number" id="splitPointInput" value="60" min="21" max="108" style="width:40px; text-align:center; font-size:10px;"></div>
                <div style="display:flex; align-items:center; gap:3px;"><label style="font-size:9px; color:#aaa;">IZQ:</label><input type="color" id="leftColorPicker" value="#5dade2" style="border:none; width:20px; height:20px; padding:0;"></div>
                <div style="display:flex; align-items:center; gap:3px;"><label style="font-size:9px; color:#aaa;">DER:</label><input type="color" id="rightColorPicker" value="#f1c40f" style="border:none; width:20px; height:20px; padding:0;"></div>
            </div>
            <div style="flex:1"></div>
            <div id="liveStatus" style="font-size:10px; color:var(--text-muted); margin-right:10px;"></div>
            <span id="liveBadge" class="badge badge-live">EN VIVO</span>
            <button id="panicBtn" class="danger">PANIC</button>
        </div>
        <div class="piano-wrapper"><div id="piano" class="piano"></div></div>
        <div id="pedalIndicator" class="pedal-bar"><div class="pedal-active"></div><div id="pedalIndicator-dot" style="display:none"></div></div>
        <div style="text-align:center; font-size:9px; color:var(--text-muted); margin-top:2px;">SUSTAIN</div>
      </div>
    </main>
  </div>

  <div id="shelf-modal" class="library-modal">
    <div class="library-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;">üìö Biblioteca de la Sala <span id="display-room-code" style="color:var(--accent)"></span></h2>
            <span class="close-modal" id="btnCloseShelf" style="font-size:30px; cursor:pointer;">&times;</span>
        </div>
        <hr style="border-color:#444; margin:15px 0;">
        <div class="upload-area">
          <h3 style="margin-top:0;">Subir Partitura (PDF)</h3>
          <p style="font-size:11px; color:#aaa; margin-bottom:10px;">M√°ximo <strong>10 MB</strong> por archivo. ¬øMuy pesado? <a href="https://www.ilovepdf.com/es/comprimir_pdf" target="_blank" style="color:var(--accent); text-decoration:none;">Comprimir PDF aqu√≠</a></p>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
              <input type="text" id="upload-title" placeholder="T√≠tulo (ej: Bach Minuet)" style="padding:8px; border-radius:4px; border:1px solid #555; background:#111; color:white; flex:1;">
              <input type="file" id="file-upload" accept="application/pdf" style="color:#aaa;">
              <button id="btnUploadScore" class="primary">‚òÅÔ∏è Subir</button>
          </div>
          <p id="upload-status" style="font-size:12px; color:#aaa; margin-top:5px;"></p>
      </div>
        <h3 style="margin-bottom:0;">Partituras Disponibles</h3>
        <div id="shelf-list" class="shelf-grid"><p style="color:#777; grid-column:1/-1;">Cargando...</p></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
  
  <script type="module" src="/js/Main.js"></script>

  <script>
   // 1. CARGAR IDENTIDAD DEL PROFESOR Y PLATAFORMA
   (async function initBranding() {
      let slug = null;
      const pathMatch = window.location.pathname.match(/\/c\/([^\/]+)/);
      if (pathMatch && pathMatch[1]) slug = pathMatch[1];
      else { const params = new URLSearchParams(window.location.search); slug = params.get('sala'); }
      
      if (slug) {
        try {
          window.PREDEFINED_ROOM = slug; 
          const res = await fetch(`/api/auth/public/${slug}`);
          if (res.ok) {
            const teacher = await res.json();
            const root = document.documentElement;
            if (teacher.branding && teacher.branding.colors) {
               const c = teacher.branding.colors;
               root.style.setProperty('--accent', c.base); root.style.setProperty('--bg', c.bg); root.style.setProperty('--panel', c.panel); root.style.setProperty('--prof-color', c.base);
            }
            const logoContainer = document.getElementById('headerLogo');
            const titleContainer = document.getElementById('headerTitle');
            const subTitleContainer = document.getElementById('headerSubtitle');

            if (teacher.branding && teacher.branding.logoUrl) {
                logoContainer.innerHTML = `<img src="${teacher.branding.logoUrl}" onerror="this.style.display='none'; this.parentNode.innerHTML='üéπ';" style="height: 38px; width: 38px; object-fit: cover; border-radius: 6px; border: 1px solid #444;">`;
            } else {
                logoContainer.innerHTML = `<div style="height:35px; width:35px; background:var(--accent); color:#000; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold;">${teacher.name.charAt(0)}</div>`;
            }
            titleContainer.textContent = teacher.name.toUpperCase();
            subTitleContainer.textContent = "SALA DE CLASES VIRTUAL | Piano Link";
            subTitleContainer.style.color = "var(--accent)";
          }
        } catch (e) { console.error("Error branding:", e); }
      }
    })();

/// 2. IDENTIDAD GLOBAL (LOGO + FAVICON)
(async function loadGlobalBrand() {
        try {
            // Conectamos con la configuraci√≥n del sistema
            const res = await fetch('/api/auth/platform-public');
            const config = await res.json();

            // A) LOGO EN LA BARRA (Powered By)
            if (config.logoUrl) {
                const sysContainer = document.getElementById('systemBrand');
                if(sysContainer) {
                    // Aseguramos visibilidad plena
                    sysContainer.style.opacity = "1";
                    sysContainer.style.transform = "none";

                    // Dise√±o: Fondo oscuro suave para resaltar el logo a color
                    sysContainer.innerHTML = `
                        <div style="display:flex; align-items:center; gap:8px; padding: 4px 10px; border-radius: 4px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size:9px; color:#ccc; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; font-family:'Inter', sans-serif;">
                                Powered by
                            </span>
                            <img src="${config.logoUrl}" 
                                 style="height:28px; width:auto; vertical-align:middle; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));"
                                 alt="Piano Link">
                        </div>
                    `;
                }
            }
            
            // B) FAVICON (Icono en la pesta√±a/URL)
            if (config.faviconUrl) {
                // Buscamos si ya existe un link de icono
                let link = document.querySelector("link[rel~='icon']");
                // Si no existe, lo creamos
                if (!link) { 
                    link = document.createElement('link'); 
                    link.rel = 'icon'; 
                    document.head.appendChild(link); 
                }
                // Le asignamos la imagen del sistema
                link.href = config.faviconUrl;
            }

            // C) T√çTULO DE LA PESTA√ëA
            if (config.name) {
                document.title = `${config.name} | Aula Virtual`;
            }
            
        } catch (e) { console.log("Usando marca por defecto"); }
    })();

   // 3. GESTI√ìN DE ROL (Login/Invitado)
   (function() {
        const nameInput = document.getElementById('inputName');
        const roleIndicator = document.getElementById('roleIndicator');
        const urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('role') === 'student') {
            if(nameInput) {
                nameInput.value = ""; nameInput.readOnly = false; nameInput.disabled = false;
                nameInput.style.color = "#fff"; nameInput.style.cursor = "text"; nameInput.placeholder = "Ingresa tu nombre...";
            }
            if(roleIndicator) { roleIndicator.textContent = "Alumno Invitado"; roleIndicator.style.background = "#5dade2"; }
            return; 
        }

        const userRaw = localStorage.getItem('pianoUser');
        if(userRaw) {
            const user = JSON.parse(userRaw);
            if(nameInput) {
                nameInput.value = user.name || "Usuario"; nameInput.readOnly = true; 
                nameInput.style.color = "#888"; nameInput.style.cursor = "not-allowed";
            }
            const role = user.role === 'admin' ? 'teacher' : (user.role || 'student');
            if(roleIndicator) {
                roleIndicator.textContent = (role === 'teacher') ? "Profesor" : "Alumno";
                roleIndicator.style.background = (role === 'teacher') ? "var(--prof-color)" : "#5dade2";
            }
            if(role === 'teacher') { const rt = document.getElementById('radioTeacher'); if(rt) rt.checked = true; }
        } else {
            if(nameInput) { nameInput.readOnly = false; nameInput.style.cursor = "text"; }
        }
    })();
  </script>
</body>
</html>