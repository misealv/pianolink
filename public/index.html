<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>PianoLink ‚Äì Conexi√≥n MIDI remota</title>
    <style>
      :root {
        --bg-main: #f5f7fa;
        --primary: #1976d2;
        --primary-dark: #0d47a1;
        --accent: #ffc107;
        --text-main: #222222;
        --text-muted: #555555;
        --card-bg: #ffffff;
        
        --teacher-rgb: 33, 150, 243; /* Azul */
        --student-rgb: 255, 193, 7;  /* Amarillo */
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg-main);
        color: var(--text-main);
      }

      .hero {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: linear-gradient(90deg, #1e88e5, #1565c0);
        color: white;
      }
      .hero-left { max-width: 70%; }
      .hero-title { margin: 0 0 6px 0; font-size: 24px; letter-spacing: 0.5px; }
      .hero-subtitle { margin: 0 0 4px 0; font-size: 14px; opacity: 0.9; }
      .hero-tagline { margin: 0; font-size: 12px; opacity: 0.9; }
      .hero-right { text-align: right; display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: rgba(0,0,0,0.2);
      }
      .status-badge::before {
        content: "";
        width: 8px; height: 8px;
        border-radius: 50%;
        background: #ffeb3b;
      }
      .status-connecting::before { background: #ffeb3b; }
      .status-connected::before  { background: #4caf50; }
      .status-disconnected::before { background: #f44336; }

      .hero-project { font-size: 11px; opacity: 0.8; }

      .panic-btn {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.6);
        background: rgba(244, 67, 54, 0.25);
        color: white;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
      }
      .panic-btn:hover {
        background: rgba(244, 67, 54, 0.45);
      }

      main { padding: 12px 16px 24px; max-width: 1200px; margin: 0 auto; }

      .card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 12px 14px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(15, 23, 42, 0.08);
        border: 1px solid #dde3ee;
      }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px 0;
      }

      .section {
        margin-bottom: 8px;
        font-size: 13px;
      }

      .role-help {
        font-size: 11px;
        color: #607d8b;
        margin-top: 4px;
      }

      label { font-size: 13px; }

      button {
        font-size: 13px;
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #1565c0;
        background: #1976d2;
        color: white;
        cursor: pointer;
        margin-right: 4px;
        min-width: 80px;
      }
      button:disabled {
        opacity: 0.6; cursor: default; background: #b0bec5; color: #eceff1; border-color: #90a4ae;
      }
      button.secondary {
        border-color: #607d8b; background: #eceff1; color: #37474f;
      }
      button.danger {
        background: #d32f2f; color: white; border: 1px solid #b71c1c;
      }
      button.small {
        padding: 4px 8px; font-size: 12px;
      }
      button:hover:not(:disabled) { background: var(--primary-dark); }
      
      input[type="text"], #codigoSala, #inviteLink {
        padding: 5px 7px; border-radius: 4px; border: 1px solid #c5cad3;
        font-size: 13px; min-width: 120px;
      }
      #inviteLink { width: 100%; }
      select { padding: 5px 7px; border-radius: 4px; border: 1px solid #c5cad3; font-size: 13px; }

      /* Piano */
      .piano-wrapper {
        border: 1px solid #999; overflow-x: auto; overflow-y: hidden;
        height: 180px; background: #dde1eb; border-radius: 4px;
      }
      .piano { position: relative; height: 100%; }
      .key {
        position: absolute; box-sizing: border-box; transition: transform 0.05s ease, background-color 0.05s ease;
      }
      .white-key {
        height: 100%; background: #ffffff; border: 1px solid #000; bottom: 0; z-index: 1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
      }
      .black-key {
        height: 55%; background: #000000; border: 1px solid #000; top: 0; z-index: 5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
      }
      .note-label {
        position: absolute; bottom: 2px; left: 2px; font-size: 8px; color: #333; pointer-events: none;
      }
      
      .white-key.active-teacher, .white-key.active-student {
        transform: translateY(4px); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .black-key.active-teacher, .black-key.active-student {
        transform: translateY(3px); box-shadow: inset 0 2px 3px rgba(255, 255, 255, 0.25);
      }

      .pedal-indicator {
        font-size: 11px; font-weight: bold; padding: 4px 10px; border-radius: 999px;
        border: 1px solid #b0bec5; background: #e0e0e0; color: #455a64; text-transform: uppercase; letter-spacing: 0.04em;
      }
      .pedal-indicator.active {
        background: #4caf50; color: #ffffff; border-color: #388e3c; box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
      }

      .layout-grid { display: grid; grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr); gap: 16px; }

      /* Participantes */
      #participantsCard {
        margin-top: 10px;
      }
      .participants-list {
        max-height: 160px;
        overflow-y: auto;
        font-size: 13px;
        margin-top: 6px;
      }
      .participant-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 0;
        border-bottom: 1px solid #eee;
      }
      .participant-name {
        font-weight: 500;
      }
      .participant-role {
        font-size: 11px;
        color: #777;
        margin-left: 6px;
      }
      .participant-controls {
        font-size: 12px;
        white-space: nowrap;
      }

      @media (max-width: 768px) {
        .layout-grid { grid-template-columns: 1fr; }
        .hero, .hero-right { text-align: left; align-items: flex-start; }
      }
      .footer { margin-top: 18px; font-size: 11px; text-align: center; color: #777; }
    </style>
  </head>

  <body>
    <header class="hero">
      <div class="hero-left">
        <h1 class="hero-title">PianoLink</h1>
        <p class="hero-subtitle">Conexi√≥n MIDI remota en tiempo real.</p>
        <p class="hero-tagline">
          <span style="color: #ffc107; font-weight: bold;">‚ñ† Alumno (Amarillo)</span> | 
          <span style="color: #82b1ff; font-weight: bold;">‚ñ† Profesor (Azul)</span>
        </p>
      </div>
      <div class="hero-right">
        <div id="connectionStatus" class="status-badge status-connecting">Conectando...</div>
        <button id="panicBtn" class="panic-btn">üîá Reset / P√°nico</button>
        <div class="hero-project" style="margin-top:8px;">by Miguel Antonio</div>
      </div>
    </header>

    <main>
      <div class="card">
        <h2 class="section-title">1. ¬øQui√©n eres?</h2>
        <div class="section">
          <label><input type="radio" name="rol" value="teacher" checked /> Profesor</label>
          &nbsp;&nbsp;
          <label><input type="radio" name="rol" value="student" /> Alumno</label>
        </div>
        <div style="margin-top:10px; margin-bottom:10px;">
          <input type="text" id="inputName" placeholder="Tu Nombre (Ej: Juan)" style="width:100%; font-weight:bold;">
        </div>
        <div id="roleHelp" class="role-help"></div>
      </div>

      <div class="card" id="roomCard">
        <h2 class="section-title">2. Conectarse a la misma sala</h2>
        <div class="section">
          <button id="crearSala">Crear sala</button>
          <input id="codigoSala" placeholder="C√≥digo de sala" />
          <button id="unirseSala">Unirse</button>
        </div>
        <div class="section" id="inviteSection">
          <div style="font-size:12px; margin-bottom:4px;">Link de invitaci√≥n para alumnos:</div>
          <input id="inviteLink" readonly />
          <div style="margin-top:6px;">
            <button id="copyInviteBtn">Copiar link</button>
          </div>
        </div>
      </div>

      <div class="layout-grid">
        <div>
          <div class="card" id="noteCard">
            <h2 class="section-title">3. Nota actual</h2>
            <div class="note-box" id="noteDisplay">‚Äî</div>
          </div>

          <div class="card" id="pianoCard">
            <div class="section-header">
              <h2 class="section-title">Piano visual</h2>
              <div id="sustainPedal" class="pedal-indicator">Sustain</div>
            </div>
            <div class="piano-wrapper"><div id="piano" class="piano"></div></div>
          </div>
        </div>

        <div>
          <div class="card" id="advancedCard">
            <h2 class="section-title">Opciones</h2>
            <div class="section">
              <label>Salida MIDI: <select id="midiOutputSelect"><option value="">(ninguna)</option></select></label>
            </div>
            <div class="section">
              <label><input type="checkbox" id="toggleMidiOut" /> Activar salida MIDI a mi teclado</label>
            </div>
          </div>

          <div class="card" id="participantsCard">
            <h2 class="section-title">Participantes</h2>
            <div id="participantsList" class="participants-list">
              <div class="inline-help">Cuando seas profesor, aqu√≠ podr√°s elegir qu√© alumnos escuchar.</div>
            </div>
          </div>

          <div class="card" id="logCard">
            <h2 class="section-title">Log</h2>
            <div id="log" class="log"></div>
          </div>
        </div>
      </div>

      <div class="footer">
        PianoLink ‚Äì MIDI remoto para clases de piano ¬∑ by Miguel Antonio
      </div>
    </main>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();

      // Referencias DOM
      const inputName = document.getElementById("inputName");
      const crearSala = document.getElementById("crearSala");
      const unirseSala = document.getElementById("unirseSala");
      const codigoSala = document.getElementById("codigoSala");
      const logDiv = document.getElementById("log");
      const toggleMidiOut = document.getElementById("toggleMidiOut");
      const midiOutputSelect = document.getElementById("midiOutputSelect");
      const piano = document.getElementById("piano");
      const roleHelp = document.getElementById("roleHelp");
      const noteDisplay = document.getElementById("noteDisplay");
      const advancedCard = document.getElementById("advancedCard");
      const logCard = document.getElementById("logCard");
      const inviteLinkInput = document.getElementById("inviteLink");
      const copyInviteBtn = document.getElementById("copyInviteBtn");
      const inviteSection = document.getElementById("inviteSection");
      const statusEl = document.getElementById("connectionStatus");
      const sustainPedalEl = document.getElementById("sustainPedal");
      const panicBtn = document.getElementById("panicBtn");
      const participantsList = document.getElementById("participantsList");

      const teacherRadio = document.querySelector('input[name="rol"][value="teacher"]');
      const studentRadio = document.querySelector('input[name="rol"][value="student"]');

      // Estado Global
      let rol = "teacher";
      let salaActual = null;
      let myName = "";
      let lockStudentFromLink = false;

      let mySocketId = null;
      let participants = [];
      let listeningTo = new Set();

      let midiAccessGlobal = null;
      let midiOutput = null;
      let midiOutputs = [];
      let enableMidiOut = false;
      const keyElementsByNote = {};

      // ===========================
      // 1. L√ìGICA DE SALAS
      // ===========================

      function log(msg) {
        const line = document.createElement("div");
        line.textContent = msg;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(state) {
        statusEl.classList.remove("status-connecting", "status-connected", "status-disconnected");
        if (state === "connected") {
          statusEl.classList.add("status-connected");
          statusEl.textContent = "Conectado";
        } else if (state === "disconnected") {
          statusEl.classList.add("status-disconnected");
          statusEl.textContent = "Desconectado";
        } else {
          statusEl.classList.add("status-connecting");
          statusEl.textContent = "Conectando...";
        }
      }

      socket.on("connect", () => {
        mySocketId = socket.id;
        updateStatus("connected");
        // Si se reconecta y ya ten√≠a sala, volver a unirse con nombre y rol
        if (salaActual && myName) {
          socket.emit("join-room", { roomCode: salaActual, username: myName, userRole: rol });
        }
      });
      socket.on("disconnect", () => updateStatus("disconnected"));
      socket.on("connect_error", () => updateStatus("disconnected"));

      socket.on("room-users", (users) => {
        participants = users || [];
        renderParticipants();
      });

      setInterval(() => {
        if (socket.connected) socket.emit("ping_keep_alive"); // Mantener conexi√≥n activa
      }, 25000);

      function updateInviteLink() {
        if (rol !== "teacher" || !salaActual) {
          inviteLinkInput.value = "";
          return;
        }
        const url = new URL(window.location.href);
        url.searchParams.set("role", "student");
        url.searchParams.set("room", salaActual);
        inviteLinkInput.value = url.toString();
      }

      function renderParticipants() {
        participantsList.innerHTML = "";
        if (!participants.length) {
          const d = document.createElement("div");
          d.className = "inline-help";
          d.textContent = "A√∫n no hay participantes.";
          participantsList.appendChild(d);
          return;
        }
        const soyProfe = (rol === "teacher");
        participants.forEach(u => {
          const row = document.createElement("div");
          row.className = "participant-row";

          const left = document.createElement("div");
          const n = document.createElement("span");
          n.className = "participant-name";
          n.textContent = u.name;
          const r = document.createElement("span");
          r.className = "participant-role";
          r.textContent = (u.role === "teacher" ? "Profesor" : "Alumno");
          left.appendChild(n);
          left.appendChild(r);

          const right = document.createElement("div");
          right.className = "participant-controls";

          if (soyProfe && u.role !== "teacher" && u.socketId !== mySocketId) {
            const label = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = (listeningTo.size === 0) || listeningTo.has(u.socketId);
            cb.addEventListener("change", () => toggleListen(u.socketId, cb.checked));
            label.appendChild(cb);
            label.appendChild(document.createTextNode(" Escuchar"));
            right.appendChild(label);
          } else if (u.socketId === mySocketId) {
            right.textContent = "T√∫";
          }

          row.appendChild(left);
          row.appendChild(right);
          participantsList.appendChild(row);
        });
      }

      function toggleListen(id, checked) {
        if (checked) listeningTo.add(id);
        else listeningTo.delete(id);
      }

      copyInviteBtn.addEventListener("click", () => {
        const value = inviteLinkInput.value.trim();
        if (!value) return alert("Crea una sala primero.");
        navigator.clipboard.writeText(value)
          .then(() => log("Link copiado al portapapeles."))
          .catch(() => alert("No se pudo copiar. Copia el texto manualmente."));
      });

      // Definir rol al cambiar radio
      teacherRadio.addEventListener("change", () => {
        if (teacherRadio.checked) {
          rol = "teacher";
          roleHelp.textContent = "Modo Profesor: tu sonido se env√≠a a los alumnos, no te escuchas a ti mismo.";
        }
      });
      studentRadio.addEventListener("change", () => {
        if (studentRadio.checked) {
          rol = "student";
          roleHelp.textContent = "Modo Alumno: escuchas al profesor, y √©l puede escucharte a ti.";
        }
      });
      roleHelp.textContent = "Modo Profesor: tu sonido se env√≠a a los alumnos, no te escuchas a ti mismo.";

      // CREAR SALA
      crearSala.addEventListener("click", () => {
        const name = inputName.value.trim();
        if(!name) return alert("Por favor ingresa tu nombre primero.");
        
        myName = name;
        rol = "teacher";
        teacherRadio.checked = true;
        
        // Solicitar al servidor
        socket.emit("create-room", { username: name, userRole: "teacher" });
        log(`‚è≥ Solicitando nueva sala como Profesor...`);
      });

      // Respuesta del Servidor (Aqu√≠ se genera el link)
      socket.on("room-created", (code) => {
        salaActual = code;
        codigoSala.value = code; // Poner el c√≥digo en la caja
        log(`‚úÖ Sala creada con √©xito: ${code}`);
        updateInviteLink();
        inviteSection.style.display = "block";
      });

      // UNIRSE SALA
      unirseSala.addEventListener("click", () => {
        const code = codigoSala.value.trim().toUpperCase();
        const name = inputName.value.trim();

        if(!name) return alert("Ingresa tu nombre.");
        if(!code) return alert("Ingresa el c√≥digo de la sala.");

        myName = name;
        salaActual = code;
        socket.emit("join-room", { roomCode: code, username: name, userRole: rol });
        log(`‚è≥ Uni√©ndose a sala ${code} como ${rol}...`);
        updateInviteLink();
      });

      socket.on("room-error", (msg) => {
        log("‚ö†Ô∏è " + msg);
        alert(msg);
      });

      // Leer par√°metros de la URL para auto-unirse
      (function parseUrlParamsForStudent() {
        const url = new URL(window.location.href);
        const roleFromUrl = url.searchParams.get("role");
        const roomFromUrl = url.searchParams.get("room");
        if (roleFromUrl === "student" && roomFromUrl) {
          studentRadio.checked = true;
          rol = "student";
          salaActual = roomFromUrl;
          codigoSala.value = roomFromUrl;
          lockStudentFromLink = true;
          roleHelp.textContent = "Entraste con link de alumno. Ingresa tu nombre y aprieta UNIRSE SALA.";
        }
      })();

      // ===========================
      // 2. MIDI
      // ===========================

      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess()
          .then(onMIDISuccess, () => log("‚ùå Sin soporte MIDI"));
      } else { log("‚ö†Ô∏è Navegador no soporta Web MIDI"); }

      function onMIDISuccess(midi) {
        midiAccessGlobal = midi;
        log("‚úÖ MIDI Activo");
        for (let input of midi.inputs.values()) {
          input.onmidimessage = handleMIDIMessageFromDevice;
        }
        midiOutputs = Array.from(midi.outputs.values());
        midiOutputSelect.innerHTML = '<option value="">(ninguna)</option>';
        midiOutputs.forEach((out, index) => {
          const opt = document.createElement("option");
          opt.value = index; opt.textContent = out.name;
          midiOutputSelect.appendChild(opt);
        });
      }

      toggleMidiOut.addEventListener("change", (e) => {
        enableMidiOut = e.target.checked;
        log("Salida MIDI: " + (enableMidiOut ? "ON" : "OFF"));
      });
      midiOutputSelect.addEventListener("change", (e) => {
        const idx = e.target.value;
        midiOutput = (idx !== "" && midiOutputs[idx]) ? midiOutputs[idx] : null;
      });

      function handleMIDIMessageFromDevice(event) {
        const [status, data1, data2] = event.data;
        const command = status & 0xf0;
        const note = data1;
        const velocity = data2;

        // Visualizar localmente en el teclado gr√°fico
        handleRemoteOrLocalNote({
          type: "raw_midi",
          command,
          note,
          velocity,
          fromRole: rol
        });

        if (!salaActual) return; // No enviar si no hay sala

        // Enviar a la red
        if (command === 0x90 || command === 0x80) {
          socket.emit("midi-message", {
            type: "note",
            command,
            note,
            velocity,
            roomCode: salaActual,
            fromRole: rol
          });
        } else if (command === 0xb0) {
          const controller = data1;
          const value = data2;
          socket.emit("midi-message", {
            type: "cc",
            status,
            controller,
            value,
            roomCode: salaActual,
            fromRole: rol
          });
        }
      }

      // Procesar MIDI Remoto
      socket.on("midi-message", (msg) => handleRemoteOrLocalNote(msg));

      function handleRemoteOrLocalNote(msg) {
        let cmd, note, velocity, role, type;
        const fromSocketId = msg.fromSocketId || null;

        if (msg.type === "raw_midi") {
          cmd = msg.command;
          note = msg.note;
          velocity = msg.velocity;
          role = msg.fromRole;
          type = "raw";
        } else if (msg.type === "note") {
          cmd = msg.command & 0xf0;
          note = msg.note;
          velocity = msg.velocity;
          role = msg.fromRole;
          type = "remote";
        } else {
          handleOtherMessages(msg);
          return;
        }

        const isNoteOn = (cmd === 0x90) && (velocity > 0);
        
        // Visualizaci√≥n
        const keyEl = keyElementsByNote[note];
        if (keyEl) {
          const activeClass = (role === "teacher") ? "active-teacher" : "active-student";
          if (isNoteOn) {
            keyEl.classList.add(activeClass);
          } else {
            keyEl.classList.remove("active-teacher", "active-student");
            keyEl.style.backgroundColor = "";
          }
        }

        if (isNoteOn && type !== "raw") {
          noteDisplay.textContent = `${role === "teacher" ? "PROFE" : "ALUMNO"}: ${noteNumberToName(note)}`;
        }

        // Salida de Audio (Filtrado por rol y, en el caso del profesor, por alumno seleccionado)
        if (type !== "raw") {
          const soyProfe = rol === "teacher";
          const vieneDeProfe = role === "teacher";
          let deboReproducir = enableMidiOut && midiOutput &&
            ((soyProfe && !vieneDeProfe) || (!soyProfe && vieneDeProfe));

          // Si soy profesor y el mensaje viene de un alumno, filtrar por listeningTo
          if (deboReproducir && soyProfe && !vieneDeProfe) {
            if (listeningTo.size > 0 && fromSocketId && !listeningTo.has(fromSocketId)) {
              deboReproducir = false;
            }
          }

          if (deboReproducir) {
            try { midiOutput.send([isNoteOn ? 0x90 : 0x80, note, velocity]); } catch(e){}
          }
        }
      }

      function handleOtherMessages(msg) {
        if (msg.type === "raw_midi") { 
          if ((msg.command & 0xf0) === 0xb0 && msg.note === 64) updatePedalVisual(msg.velocity);
          return;
        }

        if (msg.type === "cc" && msg.controller === 64) updatePedalVisual(msg.value);
        
        // Replicar CC remoto si corresponde
        const soyProfe = rol === "teacher";
        const vieneDeProfe = msg.fromRole === "teacher";
        let deboReproducir = enableMidiOut && midiOutput &&
          ((soyProfe && !vieneDeProfe) || (!soyProfe && vieneDeProfe));

        // Filtro por alumno seleccionado en el caso del profesor
        if (deboReproducir && soyProfe && !vieneDeProfe) {
          const fromSocketId = msg.fromSocketId || null;
          if (listeningTo.size > 0 && fromSocketId && !listeningTo.has(fromSocketId)) {
            deboReproducir = false;
          }
        }

        if (deboReproducir && msg.type === "cc") midiOutput.send([msg.status, msg.controller, msg.value]);
      }

      // Utils
      function updatePedalVisual(value) {
          sustainPedalEl.classList.toggle("active", value >= 64);
      }

      function noteNumberToName(note) {
        const names = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        return names[note % 12] + (Math.floor(note / 12) - 1);
      }

      // Construir Piano
      (function buildPiano() {
        const WHITE_KEYS = [0,2,4,5,7,9,11];
        const pianoDiv = document.getElementById("piano");
        pianoDiv.style.width = (52 * 26) + "px";
        let wIdx = 0;
        for (let i=21; i<=108; i++) {
          const isWhite = WHITE_KEYS.includes(i%12);
          const k = document.createElement("div");
          k.className = `key ${isWhite ? "white-key" : "black-key"}`;
          k.dataset.note = i;
          if (isWhite) {
            k.style.left = (wIdx * 26) + "px"; k.style.width = "26px";
            if (i%12===0) k.innerHTML = `<div class="note-label">${noteNumberToName(i)}</div>`;
            wIdx++;
          } else {
            k.style.left = ((wIdx-0.5)*26 - 8) + "px"; k.style.width = "16px";
          }
          pianoDiv.appendChild(k);
          keyElementsByNote[i] = k;
        }
      })();

      // Bot√≥n P√°nico
      panicBtn.addEventListener("click", () => {
        log("üîá P√°nico presionado");
        document.querySelectorAll(".key").forEach(k => {
           k.classList.remove("active-teacher", "active-student");
           k.style.backgroundColor = "";
        });
        updatePedalVisual(0);
        if (midiOutput) {
            for (let c=0; c<16; c++) midiOutput.send([0xB0|c, 123, 0]);
        }
      });
    </script>
  </body>
</html>
