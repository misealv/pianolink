<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Piano Link | Super Admin</title>
  <style>
    body { background-color: #1a1a1a; color: #dcdcdc; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    
    header {
      background: #262626; border-bottom: 1px solid #454545; padding: 15px 30px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { font-size: 18px; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Botones del Header */
    .nav-btn { position: relative; background: transparent; border: 1px solid #555; color: #aaa; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 12px; margin-left: 10px; transition: 0.2s; }
    .nav-btn:hover, .nav-btn.active { background: #444; color: #fff; border-color: #777; }
    .logout-btn { background: #ff4d4d; border: none; color: white; }
    
    .badge-count {
        position: absolute; top: -8px; right: -8px;
        background-color: #ff4d4d; color: white; font-size: 10px; font-weight: bold;
        padding: 2px 6px; border-radius: 50px; border: 1px solid #1a1a1a;
        display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .container { display: flex; height: calc(100vh - 60px); }
    
    /* Panel Izquierdo */
    .create-panel { width: 350px; padding: 30px; border-right: 1px solid #454545; background: #202020; }
    h2 { color: #ff764d; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
    
    label { display: block; font-size: 11px; margin-bottom: 5px; color: #aaa; }
    input { width: 100%; padding: 10px; margin-bottom: 15px; background: #111; border: 1px solid #454545; color: #fff; border-radius: 4px; box-sizing: border-box; }
    button.action-btn { width: 100%; padding: 12px; background: #ff764d; border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; }
    
    /* Panel Derecho */
    .list-panel { flex: 1; padding: 30px; overflow-y: auto; }
    
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; border-bottom: 2px solid #454545; padding: 10px; color: #888; text-transform: uppercase; font-size: 11px; }
    td { border-bottom: 1px solid #333; padding: 12px 10px; vertical-align: middle; }
    
    .btn-founder { background: transparent; border: 1px solid #555; color: #777; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 11px; transition: all 0.3s ease; }
    .btn-founder.active { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); border: 1px solid #cfaa56; color: #3e2723; font-weight: bold; box-shadow: 0 0 5px rgba(255, 215, 0, 0.4); }
    .btn-delete { background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }

    /* Estilos del Chat */
    .chat-layout { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 140px); background: #202020; border: 1px solid #444; border-radius: 8px; overflow: hidden; }
    
    .chat-sidebar { background: #1a1a1a; border-right: 1px solid #333; overflow-y: auto; }
    .chat-user-item { padding: 15px; border-bottom: 1px solid #2a2a2a; cursor: pointer; transition: 0.2s; }
    .chat-user-item:hover, .chat-user-item.active { background: #333; }
    .chat-user-name { font-weight: bold; color: #fff; font-size: 13px; display: block; }
    .chat-user-meta { font-size: 11px; color: #888; }
    .unread-dot { display: inline-block; width: 8px; height: 8px; background: #ff764d; border-radius: 50%; margin-left: 5px; }

    .chat-main { display: flex; flex-direction: column; background: #202020; }
    .chat-header { padding: 15px; border-bottom: 1px solid #333; background: #262626; font-weight: bold; color: #ddd; }
    
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    
    .msg-bubble { max-width: 70%; padding: 10px 15px; border-radius: 8px; font-size: 13px; line-height: 1.4; position: relative; }
    
    .msg-teacher { align-self: flex-start; background: #333; color: #ddd; border-top-left-radius: 0; }
    .msg-teacher .sender-name { font-size: 10px; color: #ff764d; margin-bottom: 3px; display: block; font-weight: bold; }

    .msg-admin { align-self: flex-end; background: #5dade2; color: #000; border-top-right-radius: 0; }
    
    .msg-time { font-size: 9px; opacity: 0.6; display: block; margin-top: 5px; text-align: right; }

    .chat-input-area { padding: 15px; background: #262626; border-top: 1px solid #333; display: flex; gap: 10px; }
    .chat-input-area textarea { flex: 1; height: 40px; background: #111; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; resize: none; }
    .btn-send { background: #ff764d; border: none; padding: 0 20px; color: black; font-weight: bold; border-radius: 4px; cursor: pointer; }
    .btn-send:hover { background: #ff9f7e; }

    .view-section { display: none; }
    .view-section.active { display: block; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #202020; padding: 25px; border-radius: 8px; width: 400px; border: 1px solid #444; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .modal-content h3 { margin-top: 0; color: #ff764d; }
    .modal-content textarea { width: 100%; height: 100px; margin: 10px 0; resize: none; background: #111; color: white; border: 1px solid #444; padding: 10px; }
  </style>
</head>
<body>

  <header>
    <div class="brand">üéπ Super Admin</div>
    <div style="display:flex; align-items:center;">
        <button class="nav-btn active" onclick="switchView('teachers')" id="btnTeachers">üë®‚Äçüè´ Profesores</button>
        <button class="nav-btn" onclick="switchView('feedback')" id="btnFeedback">
            üì® Buz√≥n <span id="msgBadge" class="badge-count">0</span>
        </button>
        <button class="nav-btn" onclick="openBroadcastModal()" style="border-color:#ff764d; color:#ff764d;">
            üì¢ Mensaje General
        </button>
        <div style="width: 20px;"></div>
        <button class="nav-btn logout-btn" onclick="logout()">Salir</button>
    </div>
  </header>

  <div class="container">
    <div class="create-panel">
      <h2>+ Nuevo Profesor</h2>
      <form id="createForm">
        <label>Nombre</label>
        <input type="text" id="name" required>
        
        <label>Email</label>
        <input type="email" id="email" required>
        
        <label>Slug (URL Personalizada)</label>
        <input type="text" id="slug" placeholder="Ej: miguel (d√©jalo vac√≠o si no quieres)">
        
        <label>Contrase√±a</label>
        <input type="text" id="password" required>
        
        <div style="margin-bottom: 20px; display: flex; align-items: center;">
            <input type="checkbox" id="chkFounder" style="width: auto; margin: 0 10px 0 0;">
            <label for="chkFounder" style="margin: 0; color: #ffbf00; font-weight: bold; cursor:pointer;">‚òÖ Profesor Fundador</label>
        </div>
      
        <button type="submit" class="action-btn">Crear Cuenta</button>
      </form>
      <div id="statusMsg" style="margin-top:15px; font-weight:bold; font-size:12px;"></div>
    </div>

    <div class="list-panel">
        
        <div id="view-teachers" class="view-section active">
            <h2>Staff Docente Activo</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th><th>Email</th><th>URL</th><th>Fundador</th><th>Acciones</th> 
                    </tr>
                </thead>
                <tbody id="teachersTable"><tr><td colspan="5">Cargando...</td></tr></tbody>
            </table>
        </div>

        <div id="view-feedback" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>üì® Centro de Mensajer√≠a</h2>
                <button onclick="loadChatSystem()" style="background:transparent; border:none; color:#888; cursor:pointer; font-size:11px;">‚Üª Recargar</button>
            </div>

            <div class="chat-layout">
                <div class="chat-sidebar" id="chatUserList">
                    <div style="padding:15px; color:#666;">Cargando usuarios...</div>
                </div>

                <div class="chat-main">
                    <div class="chat-header" id="chatHeader">Selecciona un profesor</div>
                    
                    <div class="chat-messages" id="chatContainer">
                        <div style="display:flex; height:100%; align-items:center; justify-content:center; color:#555;">
                            Selecciona un usuario de la izquierda para ver el historial.
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <textarea id="replyInput" placeholder="Escribe una respuesta..."></textarea>
                        <button class="btn-send" onclick="sendReply()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
  </div>

  <div id="msgModal" class="modal-overlay">
    <div class="modal-content">
        <h3>‚úâÔ∏è Enviar Mensaje</h3>
        <p id="msgRecipientName" style="color:#aaa; font-size:12px; margin-bottom:10px;"></p>
        <textarea id="msgText" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button onclick="sendAdminMessage()" class="action-btn" style="width:auto; padding:8px 15px;">Enviar</button>
            <button onclick="closeModal()" class="action-btn" style="background:#555; width:auto; padding:8px 15px;">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="editModal" class="modal-overlay">
    <div class="modal-content" style="width: 350px;">
        <h3>‚úèÔ∏è Editar Profesor</h3>
        <input type="hidden" id="editUserId">
        
        <label>Nombre</label>
        <input type="text" id="editName">
        
        <label>Email</label>
        <input type="email" id="editEmail">
        
        <label>URL (Slug)</label>
        <input type="text" id="editSlug">

        <label>üè≥Ô∏è Pa√≠s (Ej: üá®üá± Chile)</label>
        <input type="text" id="editCountry" placeholder="Ej: üá®üá± Chile">

        <div style="text-align:right; margin-top:15px;">
            <button onclick="saveTeacherChanges()" class="action-btn" style="width:auto; padding:8px 15px;">Guardar</button>
            <button onclick="document.getElementById('editModal').style.display='none'" class="action-btn" style="background:#555; width:auto; padding:8px 15px;">Cancelar</button>
        </div>
    </div>
  </div>

  <script>
    const API_TEACHERS = '/api/auth/teachers'; 
    const API_FEEDBACK = '/admin/feedbacks';   
    const API_MARK_READ = '/admin/feedbacks/mark-read'; 

    // Verificar Sesi√≥n
    const userSession = JSON.parse(localStorage.getItem('pianoUser'));
    if (!userSession || userSession.role !== 'admin') {
      window.location.href = 'login.html';
    } else {
        window.logout = function() {
            localStorage.removeItem('pianoUser');
            window.location.href = 'login.html';
        }
    }

    // NAVEGACI√ìN ENTRE VISTAS
    async function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        
        if(viewName === 'teachers') {
            document.getElementById('btnTeachers').classList.add('active');
            loadTeachers();
        } else {
            // CORREGIDO: Ahora llamamos a la funci√≥n del chat
            document.getElementById('btnFeedback').classList.add('active');
            loadChatSystem(); 
            
            const badge = document.getElementById('msgBadge');
            if (badge.style.display !== 'none') {
                badge.style.display = 'none'; 
                await markAllAsRead(); 
            }
        }
    }

    async function checkNotifications() {
        try {
            const res = await fetch(API_FEEDBACK);
            const list = await res.json();
            const unreadCount = list.filter(msg => msg.status === 'unread').length;
            const badge = document.getElementById('msgBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount; badge.style.display = 'block'; 
            } else { badge.style.display = 'none'; }
        } catch (error) { console.error(error); }
    }

    async function markAllAsRead() { try { await fetch(API_MARK_READ, { method: 'POST' }); } catch (e) {} }

    // --- PROFESORES ---
    let allTeachersData = []; 

    async function loadTeachers() {
      try {
        const res = await fetch(API_TEACHERS);
        allTeachersData = await res.json(); 
        
        const tbody = document.getElementById('teachersTable');
        tbody.innerHTML = '';
        
        allTeachersData.forEach(t => {
          const isFounder = t.isFoundingMember ? 'active' : '';
          const founderText = t.isFoundingMember ? '‚òÖ FUNDADOR' : '‚òÜ Asignar';
          const country = (t.branding && t.branding.country) ? t.branding.country : '';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-weight:bold; color:#fff;">
                ${t.name} <br> 
                <span style="font-size:10px; color:#888;">${country}</span>
            </td>
            <td style="color:#aaa;">${t.email}</td>
            <td><a href="/?sala=${t.slug || ''}" target="_blank" style="color:#5dade2;">${t.slug ? '/c/'+t.slug : '--'}</a></td>
            <td><button class="btn-founder ${isFounder}" onclick="toggleFounder('${t._id}', event)">${founderText}</button></td>
            <td>
                <button onclick="openEditModal('${t._id}')" style="cursor:pointer; background:none; border:none; font-size:16px;" title="Editar">‚úèÔ∏è</button>
                <button onclick="openMsgModal('${t._id}', '${t.name}')" style="cursor:pointer; background:none; border:none; font-size:16px;" title="Enviar Mensaje">‚úâÔ∏è</button>
                <button class="btn-delete" onclick="deleteTeacher('${t._id}')">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) { console.error(err); }
    }

    // --- EDICI√ìN ---
    function openEditModal(id) {
        const teacher = allTeachersData.find(t => t._id === id);
        if(!teacher) return;

        document.getElementById('editUserId').value = teacher._id;
        document.getElementById('editName').value = teacher.name;
        document.getElementById('editEmail').value = teacher.email;
        document.getElementById('editSlug').value = teacher.slug || '';
        document.getElementById('editCountry').value = (teacher.branding && teacher.branding.country) ? teacher.branding.country : '';
        document.getElementById('editModal').style.display = 'flex';
    }

    async function saveTeacherChanges() {
        const id = document.getElementById('editUserId').value;
        const name = document.getElementById('editName').value;
        const email = document.getElementById('editEmail').value;
        const slug = document.getElementById('editSlug').value;
        const country = document.getElementById('editCountry').value;
        
        const btn = document.querySelector('#editModal button.action-btn'); 
        btn.innerText = "Guardando...";

        try {
            const res = await fetch(`/admin/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, slug, country })
            });
            if(res.ok) {
                document.getElementById('editModal').style.display = 'none';
                loadTeachers();
            } else { alert("Error al actualizar"); }
        } catch (e) { alert("Error de conexi√≥n"); } 
        finally { btn.innerText = "Guardar"; }
    }

    // --- ACCIONES R√ÅPIDAS ---
    async function toggleFounder(id, event) {
        event.target.innerText = "...";
        try { const res = await fetch(`/admin/users/${id}/toggle-founder`, { method: 'POST' }); if (res.ok) loadTeachers(); } catch (e) {}
    }

    async function deleteTeacher(id) {
        if(!confirm("¬øEst√°s seguro de ELIMINAR a este profesor?")) return;
        try { const res = await fetch(`/api/auth/delete/${id}`, { method: 'DELETE' }); if(res.ok) loadTeachers(); } catch (e) {}
    }

    // --- MODALES MENSAJE GENERAL / INDIVIDUAL ---
    let currentRecipientId = null;
    function openMsgModal(id, name) {
        currentRecipientId = id;
        document.getElementById('msgRecipientName').innerText = "Para: " + name;
        document.getElementById('msgModal').style.display = 'flex';
    }
    function openBroadcastModal() {
        currentRecipientId = 'ALL';
        document.getElementById('msgRecipientName').innerHTML = "<strong style='color:#ff764d'>üì¢ A TODOS LOS PROFESORES</strong>";
        document.getElementById('msgModal').style.display = 'flex';
    }
    function closeModal() {
        document.getElementById('msgModal').style.display = 'none';
        document.getElementById('msgText').value = '';
    }
    async function sendAdminMessage() {
        const content = document.getElementById('msgText').value;
        if(!content) return;
        const url = (currentRecipientId === 'ALL') ? '/admin/message/send-all' : '/admin/message/send';
        const body = (currentRecipientId === 'ALL') ? { content } : { recipientId: currentRecipientId, content };
        try {
            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            if(res.ok) { alert("Enviado"); closeModal(); } else { alert("Error"); }
        } catch(e) { alert("Error conexi√≥n"); }
    }

    // --- CREAR PROFESOR ---
    const createForm = document.getElementById('createForm');
    if (createForm) {
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const statusMsg = document.getElementById('statusMsg');
            const btn = e.target.querySelector('button');
            
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const chk = document.getElementById('chkFounder');
            const isFoundingMember = chk ? chk.checked : false; 
            let slug = document.getElementById('slug').value.trim();
            if (slug === "") slug = undefined;

            btn.disabled = true; btn.innerText = "Guardando..."; statusMsg.innerText = "";

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, slug, isFoundingMember })
                });
                const data = await res.json();
                if (res.ok) {
                    statusMsg.style.color = "#2ecc71"; statusMsg.innerText = "‚úÖ " + (data.message || "OK");
                    createForm.reset(); loadTeachers();
                } else {
                    statusMsg.style.color = "#ff4d4d"; statusMsg.innerText = "‚ö†Ô∏è " + (data.message || "Error");
                }
            } catch (error) { statusMsg.style.color = "#ff4d4d"; statusMsg.innerText = "‚ùå Error conexi√≥n"; } 
            finally { btn.disabled = false; btn.innerText = "CREAR CUENTA"; }
        });
    }

    // --- üì® SISTEMA DE CHAT UNIFICADO ---
    let selectedChatUserId = null;

    async function loadChatSystem() { 
        try {
            const res = await fetch('/admin/feedbacks'); 
            const feedbacks = await res.json();
            
            // Agrupar feedbacks por usuario (Set √∫nico)
            const usersMap = new Map();
            
            feedbacks.forEach(f => {
                if(f.user && f.user._id) {
                    if(!usersMap.has(f.user._id)) {
                        usersMap.set(f.user._id, {
                            id: f.user._id,
                            name: f.user.name,
                            email: f.user.email,
                            lastDate: f.createdAt,
                            hasUnread: (f.status === 'unread')
                        });
                    } else if (f.status === 'unread') {
                        const u = usersMap.get(f.user._id);
                        u.hasUnread = true;
                    }
                }
            });
            renderUserList(Array.from(usersMap.values()));
        } catch (e) { console.error("Error cargando lista chat", e); }
    }

    function renderUserList(users) {
        const list = document.getElementById('chatUserList');
        list.innerHTML = '';
        
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = `chat-user-item ${selectedChatUserId === u.id ? 'active' : ''}`;
            div.onclick = () => loadConversation(u.id);
            
            div.innerHTML = `
                <span class="chat-user-name">
                    ${u.name} ${u.hasUnread ? '<span class="unread-dot"></span>' : ''}
                </span>
                <span class="chat-user-meta">${u.email}</span>
            `;
            list.appendChild(div);
        });
    }

    async function loadConversation(userId) {
        selectedChatUserId = userId;
        document.querySelectorAll('.chat-user-item').forEach(el => el.classList.remove('active'));
        
        const container = document.getElementById('chatContainer');
        const header = document.getElementById('chatHeader');
        container.innerHTML = '<p style="text-align:center; color:#666;">Cargando historial...</p>';

        try {
            const res = await fetch(`/admin/conversation/${userId}`);
            const data = await res.json();
            
            header.innerText = `Chat con: ${data.user.name}`;
            container.innerHTML = ''; 

            if(data.conversation.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#555;">No hay mensajes a√∫n.</p>';
                return;
            }

            data.conversation.forEach(msg => {
                const isMe = (msg.sender === 'admin');
                const div = document.createElement('div');
                div.className = `msg-bubble ${isMe ? 'msg-admin' : 'msg-teacher'}`;
                
                const senderTag = !isMe ? `<span class="sender-name">${data.user.name}</span>` : '';
                div.innerHTML = `
                    ${senderTag}
                    ${msg.content}
                    <span class="msg-time">${new Date(msg.createdAt).toLocaleString()}</span>
                `;
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
            await fetch('/admin/feedbacks/mark-read', { method: 'POST' }); 

        } catch (e) {
            container.innerHTML = '<p style="color:red">Error cargando chat.</p>';
            console.error(e);
        }
    }

    async function sendReply() {
        const txt = document.getElementById('replyInput');
        const content = txt.value.trim();
        if(!content || !selectedChatUserId) return;

        try {
            const res = await fetch('/admin/message/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ recipientId: selectedChatUserId, content })
            });

            if(res.ok) {
                txt.value = ''; 
                loadConversation(selectedChatUserId); 
            } else { alert("Error al enviar"); }
        } catch (e) { console.error(e); }
    }

    // Inicializar
    loadTeachers();       
    checkNotifications();
  </script>
</body>
</html>